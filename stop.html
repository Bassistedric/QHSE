<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QHSE – STOP</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React via CDN (même approche que tbm.html) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    /* petit confort mobile */
    body { -webkit-tap-highlight-color: transparent; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <!-- Si tu as déjà un sheetConfig.js qui expose l'URL, laisse-le -->
  <script src="sheetConfig.js"></script>

  <script>
    const { useEffect, useMemo, useState } = React;

    // ✅ A REMPLACER si tu n'as pas d'URL dans sheetConfig.js
    // Exemple: const API_URL = "https://script.google.com/macros/s/XXXX/exec";
    const API_URL = (window.SHEET_CONFIG && window.SHEET_CONFIG.API_URL) ? window.SHEET_CONFIG.API_URL : "PUT_YOUR_EXEC_URL_HERE";

    function nowIso() { return new Date().toISOString(); }

    function compressToDataUrl(file, opts = {}) {
      const maxW = opts.maxW ?? 1280;
      const quality = opts.quality ?? 0.72;
      const mimeOut = 'image/jpeg';

      return new Promise((resolve, reject) => {
        if (!file) return resolve("");

        const reader = new FileReader();
        reader.onerror = () => reject(new Error("FILE_READ_ERROR"));
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const w = img.width;
            const h = img.height;

            const scale = Math.min(1, maxW / w);
            const outW = Math.round(w * scale);
            const outH = Math.round(h * scale);

            const canvas = document.createElement("canvas");
            canvas.width = outW;
            canvas.height = outH;

            const ctx = canvas.getContext("2d", { alpha: false });
            ctx.drawImage(img, 0, 0, outW, outH);

            const dataUrl = canvas.toDataURL(mimeOut, quality);
            resolve(dataUrl);
          };
          img.onerror = () => reject(new Error("IMAGE_DECODE_ERROR"));
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function postJson(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const txt = await res.text();
      let json = null;
      try { json = JSON.parse(txt); } catch (e) {}
      if (!res.ok) throw new Error("HTTP_" + res.status);
      if (json && json.ok === false) throw new Error(json.error || "API_ERROR");
      return json || { ok: true, raw: txt };
    }

    function App() {
      const [datetime, setDatetime] = useState(() => {
        // pré-remplir "dd/mm/yyyy hh:mm" si tu préfères : ici ISO local simplifié
        const d = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      });

      const [chantier, setChantier] = useState("");
      const [responsable, setResponsable] = useState("");

      const [situation, setSituation] = useState("");
      const [callNom, setCallNom] = useState("");
      const [callFonction, setCallFonction] = useState("chef"); // chef/site/pm/opm/cp/coord/client
      const [solution, setSolution] = useState("");
      const [noGo, setNoGo] = useState(false);

      const [photoFile, setPhotoFile] = useState(null);
      const [photoPreview, setPhotoPreview] = useState("");
      const [photoDataUrl, setPhotoDataUrl] = useState("");

      const [sending, setSending] = useState(false);
      const [msg, setMsg] = useState("");
      const [lastPhotoUrl, setLastPhotoUrl] = useState("");

      const canSend = useMemo(() => {
        if (!API_URL || API_URL.includes("PUT_YOUR_EXEC_URL_HERE")) return false;
        if (!datetime.trim()) return false;
        if (!chantier.trim()) return false;
        if (!responsable.trim()) return false;
        if (!situation.trim()) return false;
        return true;
      }, [datetime, chantier, responsable, situation]);

      async function onPickPhoto(e) {
        const f = e.target.files && e.target.files[0];
        setPhotoFile(f || null);
        setMsg("");
        setLastPhotoUrl("");

        if (!f) {
          setPhotoPreview("");
          setPhotoDataUrl("");
          return;
        }

        // preview rapide (non compressée)
        const url = URL.createObjectURL(f);
        setPhotoPreview(url);

        // compression + dataUrl pour envoi
        try {
          const durl = await compressToDataUrl(f, { maxW: 1280, quality: 0.72 });
          setPhotoDataUrl(durl);
        } catch (err) {
          setPhotoDataUrl("");
          setMsg("Photo : erreur de conversion/compression.");
        }
      }

      async function onSubmit() {
        setSending(true);
        setMsg("");
        setLastPhotoUrl("");
        try {
          const payload = {
            meta: {
              formType: "stop",
              sentAt: nowIso(),
              userAgent: navigator.userAgent || ""
            },
            data: {
              datetime,
              chantier,
              responsable,
              situation,
              callNom,
              callFonction,
              solution,
              noGo: !!noGo,
              photoDataUrl: photoDataUrl || "" // optionnel
            }
          };

          const out = await postJson(API_URL, payload);

          if (out && out.photoUrl) setLastPhotoUrl(out.photoUrl);
          setMsg(noGo ? "STOP NO-GO envoyé (mail QHSE + Drive si photo)." : "STOP envoyé. Photo stockée sur Drive (si ajoutée).");

          // reset minimal
          setSituation("");
          setCallNom("");
          setSolution("");
          setNoGo(false);
          setPhotoFile(null);
          setPhotoPreview("");
          setPhotoDataUrl("");
          // note: on garde chantier/responsable/datetime pour enchaîner plus vite
        } catch (err) {
          setMsg("Erreur envoi : " + (err && err.message ? err.message : String(err)));
        } finally {
          setSending(false);
        }
      }

      return React.createElement("div", { className: "min-h-screen p-4" },
        React.createElement("div", { className: "max-w-xl mx-auto" },

          React.createElement("div", { className: "flex items-center gap-3 mb-4" },
            React.createElement("img", { src: "qhse-logo.svg", className: "h-10 w-auto", alt: "QHSE" }),
            React.createElement("div", null,
              React.createElement("h1", { className: "text-xl font-semibold" }, "STOP"),
              React.createElement("p", { className: "text-sm text-slate-600" }, "Saisir une situation, une action et (optionnel) une photo.")
            )
          ),

          (!canSend && (API_URL.includes("PUT_YOUR_EXEC_URL_HERE") || !API_URL)) ?
            React.createElement("div", { className: "mb-4 p-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-900 text-sm" },
              "⚠️ API_URL non configurée. Mets l’URL /exec dans sheetConfig.js (SHEET_CONFIG.API_URL) ou dans stop.html."
            ) : null,

          React.createElement("div", { className: "bg-white rounded-2xl shadow-sm border border-slate-200 p-4 space-y-3" },

            field("Date/Heure", datetime, setDatetime, "ex: 18/02/2026 14:30"),
            field("Chantier", chantier, setChantier, "ex: DIV ORO"),
            field("Responsable", responsable, setResponsable, "ex: Nom Prénom"),

            textArea("Situation (STOP)", situation, setSituation, "Décrire la situation à risque / l’écart observé…"),

            field("CALL – Nom", callNom, setCallNom, "Qui as-tu contacté ?"),
            selectField("CALL – Fonction", callFonction, setCallFonction, [
              ["chef", "Chef d'équipe"],
              ["site", "Site sup."],
              ["pm", "PM"],
              ["opm", "OPM"],
              ["cp", "CP"],
              ["coord", "Coordinateur"],
              ["client", "Client"],
            ]),

            textArea("ACT – Solution / actions", solution, setSolution, "Actions correctives, mesures mises en place…"),

            React.createElement("label", { className: "flex items-center gap-2 text-sm" },
              React.createElement("input", {
                type: "checkbox",
                className: "h-4 w-4",
                checked: noGo,
                onChange: e => setNoGo(e.target.checked)
              }),
              React.createElement("span", { className: "font-medium" }, "NO-GO (en attente)"),
              React.createElement("span", { className: "text-slate-500" }, "→ envoi email QHSE")
            ),

            React.createElement("div", { className: "pt-2" },
              React.createElement("div", { className: "text-sm font-medium mb-1" }, "Photo (optionnel)"),
              React.createElement("input", {
                type: "file",
                accept: "image/*",
                capture: "environment",
                onChange: onPickPhoto,
                className: "block w-full text-sm"
              }),
              photoPreview ? React.createElement("div", { className: "mt-2" },
                React.createElement("img", { src: photoPreview, className: "w-full rounded-xl border border-slate-200", alt: "Preview" }),
                React.createElement("p", { className: "text-xs text-slate-500 mt-1" },
                  photoDataUrl ? "Photo compressée prête à l’envoi." : "Compression en cours / erreur."
                )
              ) : null
            ),

            React.createElement("div", { className: "pt-2 flex gap-2" },
              React.createElement("button", {
                onClick: onSubmit,
                disabled: sending || !canSend,
                className: "flex-1 rounded-xl px-4 py-2 font-semibold text-white bg-slate-900 disabled:opacity-50"
              }, sending ? "Envoi..." : "Envoyer STOP"),
              React.createElement("a", {
                href: "index.html",
                className: "rounded-xl px-4 py-2 font-semibold border border-slate-300 text-slate-700"
              }, "Retour")
            ),

            msg ? React.createElement("div", { className: "mt-2 p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm" }, msg) : null,

            lastPhotoUrl ? React.createElement("div", { className: "text-sm" },
              React.createElement("span", { className: "font-medium" }, "Photo Drive : "),
              React.createElement("a", { href: lastPhotoUrl, target: "_blank", rel: "noreferrer", className: "underline" }, "ouvrir")
            ) : null
          )
        )
      );
    }

    function field(label, value, setValue, placeholder) {
      return React.createElement("div", null,
        React.createElement("div", { className: "text-sm font-medium mb-1" }, label),
        React.createElement("input", {
          value,
          onChange: e => setValue(e.target.value),
          placeholder: placeholder || "",
          className: "w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300"
        })
      );
    }

    function textArea(label, value, setValue, placeholder) {
      return React.createElement("div", null,
        React.createElement("div", { className: "text-sm font-medium mb-1" }, label),
        React.createElement("textarea", {
          value,
          onChange: e => setValue(e.target.value),
          placeholder: placeholder || "",
          rows: 4,
          className: "w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300"
        })
      );
    }

    function selectField(label, value, setValue, options) {
      return React.createElement("div", null,
        React.createElement("div", { className: "text-sm font-medium mb-1" }, label),
        React.createElement("select", {
          value,
          onChange: e => setValue(e.target.value),
          className: "w-full rounded-xl border border-slate-300 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
        },
          options.map(([v, t]) => React.createElement("option", { key: v, value: v }, t))
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>

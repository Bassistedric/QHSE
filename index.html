<!-- ===== DEBUT PARTIE 1/5 : HTML + CDN + SW + CONFIG/I18N/HELPERS ===== -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>QHSE ‚Äì Apps</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print{header,footer,.no-print{display:none!important}main{max-width:100%!important}section{page-break-inside:avoid}}
    .card{ @apply bg-white rounded-2xl shadow p-4 mb-4; }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="root"></div>

  <!-- PWA / Service Worker (bump ?v=... pour forcer la MAJ) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () =>
        navigator.serviceWorker.register('./sw.js?v=v5').catch(console.error)
      );
    }
  </script>

  <!-- React + Babel (CDN principal) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- ===== SCRIPT 1 : CONFIG, I18N, ROUTER, HELPERS ===== -->
  <script type="text/babel" data-presets="env,react">
    // ========================= CONFIG =========================
    // ‚¨á‚¨á Remplacer l' URL Apps Script /exec si modification du GSheet
    const COLLECT_URL = "https://script.google.com/macros/s/AKfycbw53EiERifnozNg9ybNfbn_Ofm9NrFquashw_mbYoWyqtQROS6xXXzwVT2UQ4XxcJYK/exec";

    const STORAGE_KEY     = "qhse_current_v1";
    const OUTBOX_KEY      = "qhse_outbox_v1";
    const PREFS_KEY       = "qhse_prefs_v1"; // conserve Responsable & √âquipe
    const LANG_KEY        = "qhse_lang_v1";  // fr/en/nl

    // ========================= I18N (FR/EN/NL) =========================
    // Load translation files dynamically
    if (!window.QHSE_I18N) {
      window.QHSE_I18N = {};
    }
    async function loadI18n(lang) {
      if (!window.QHSE_I18N[lang]) {
        const res = await fetch('i18n/' + lang + '.json');
        window.QHSE_I18N[lang] = await res.json();
      }
      return window.QHSE_I18N[lang];
    }
    const I18N = window.QHSE_I18N; // alias unique
   // Cl√©s i18n pour les listes
const MAP_KEYS = {
  energies: {
    electrique: 'energy_electric',
    mecanique:  'energy_mechanical',
    fluide:     'energy_fluid',
    gravite:    'energy_gravity',
  },
  env: {
    hauteur:  'env_height',
    meteo:    'env_weather',
    bruit:    'env_noise',
    poussiere:'env_dust',
    thermique:'env_thermal',
    chimique: 'env_chemical',
  },
  ops: {
    trafic:  'ops_traffic',
    levage:  'ops_lift',
    outillage:'ops_tools',
    atex:    'ops_atex',
    confine: 'ops_confined',
    autres:  'ops_others',
  },
  measures: {
    septRegles:'measures_seven',
    ventilation:'measures_ventilation',
    terre:'measures_earth',
    balisage:'measures_balisage',
    surveillant:'measures_watch',
    planLevage:'measures_liftplan',
    ancrage:'measures_anchor',
    outilsOk:'measures_toolsok',
    autre:'measures_other',
  }
};


    // ========================= HELPERS =========================
    const nowLocalDateTime = () => {
      const d=new Date(), pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const parseRoute = () => (location.hash.replace(/^#\/?/, '') || 'home');
    const saveLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
    const loadLS = (k,def)=>{ try{ const raw=localStorage.getItem(k); return raw? JSON.parse(raw): def; }catch{return def;} };

    // i18n hook & provider simples
    const I18nContext = React.createContext({ lang:'fr', t:(k)=>k, setLang:()=>{} });
    function I18nProvider({children}){
      const [lang, setLangState] = React.useState(loadLS(LANG_KEY, 'fr'));
      const [dict, setDict] = React.useState({});
      React.useEffect(()=>{ loadI18n('fr'); },[]);
      React.useEffect(()=>{ loadI18n(lang).then(setDict); },[lang]);
      const setLang = (l)=>{ setLangState(l); saveLS(LANG_KEY,l); };
      const t = (key)=> (dict && dict[key]) || (I18N.fr && I18N.fr[key]) || key;
      return <I18nContext.Provider value={{lang,t,setLang}}>{children}</I18nContext.Provider>;
    }
    const useI18n = ()=>React.useContext(I18nContext);

    // Petits composants g√©n√©riques
    // Section encadr√©e avec barre de titre + support de "tone" (couleur)
      function Section({ title, tone = "default", children }) {
        const TONES = {
          default: { border: "border-gray-200", bar: "bg-gray-50", title: "text-gray-800" },
          slate:   { border: "border-slate-300", bar: "bg-slate-50", title: "text-slate-900" },
          blue:    { border: "border-blue-300",  bar: "bg-blue-50",  title: "text-blue-900" },
          green:   { border: "border-green-300", bar: "bg-green-50", title: "text-green-900" },
          red:     { border: "border-red-300",   bar: "bg-red-50",   title: "text-red-900" },
          amber:   { border: "border-amber-300", bar: "bg-amber-50", title: "text-amber-900" },
        };
        const c = TONES[tone] || TONES.default;
      
        return (
          <section className={`rounded-2xl border ${c.border} bg-white shadow-sm overflow-hidden mb-4`}>
            <div className={`px-4 py-2 border-b ${c.border} ${c.bar} text-sm font-semibold ${c.title}`}>
              {title}
            </div>
            <div className="p-4">
              {children}
            </div>
          </section>
        );
      }

    function Row({ children }){ return <div className="flex flex-col gap-3">{children}</div>; }
    function Toggle({ checked, onChange, label }){ return <label className="flex items-center justify-between gap-3 py-2"><span className="text-sm">{label}</span><input type="checkbox" className="w-5 h-5 accent-black" checked={checked} onChange={(e)=>onChange(e.target.checked)} /></label>; }
    function Divider(){ return <hr className="my-3 border-gray-200" />; }

    // Envoi + file d‚Äôattente locale (offline)
    async function sendNow(payload){
      try{
        await fetch(COLLECT_URL, { method:"POST", mode:"no-cors", headers:{ "Content-Type":"text/plain" }, body: JSON.stringify(payload) });
        return true;
      }catch(e){ console.warn(e); return false; }
    }
    function enqueueOutbox(item){
      const box = loadLS(OUTBOX_KEY, []);
      box.unshift(item);
      saveLS(OUTBOX_KEY, box.slice(0,500));
    }
    async function flushOutbox(){
      let box = loadLS(OUTBOX_KEY, []);
      if(!box.length) return {sent:0,left:0};
      let sent=0, left=[];
      for(const it of box){
        const ok = await sendNow(it);
        if(ok) sent++; else left.push(it);
      }
      saveLS(OUTBOX_KEY, left);
      return {sent,left:left.length};
    }
    window.addEventListener('online', ()=>{ flushOutbox(); });

    // Pr√©f√©rences (Responsable & √âquipe conserv√©s)
    const defaultPrefs = { responsable:"", team:[] };
  </script>
<!-- ===== FIN PARTIE 1/5 ===== -->
<!-- ===== HOTFIX: composant Tile global (√† mettre AVANT la PARTIE 2/5) ===== -->
<script type="text/babel">
  if (!window.QHSE_Tile) {
    window.QHSE_Tile = function Tile({href, icon, img, title, sub, muted}) {
      const base = "rounded-2xl p-4 text-center transition border";
      const active = "hover:bg-gray-50";
      const off = "border-dashed text-gray-300 pointer-events-none select-none";
      return (
        <a href={href||"#"} className={[base, muted?off:active].join(" ")}>
          {img ? (
            <img src={img} alt="" className={"w-10 h-10 mx-auto rounded " + (muted?"opacity-40":"")} />
          ) : (
            <div className={"text-3xl font-bold " + (muted?"opacity-40":"")}>{icon || "Ôºã"}</div>
          )}
          {title && <div className="font-semibold mt-2">{title}</div>}
          {sub && <div className="text-xs text-gray-500 mt-0.5">{sub}</div>}
        </a>
      );
    };
  }
</script>

<!-- ===== DEBUT PARTIE 2/5 : HOME (grille 2√ó2 cadr√©e, QR, how-to) ===== -->
<script type="text/babel" data-presets="env,react">
  function HomeScreen(){
    const { t } = useI18n();

    // Fallback : si le composant global n‚Äôexiste pas, on en cr√©e un local
    const TileC = window.QHSE_Tile || function Tile({href, icon, img, title, sub, muted}) {
      const base = "rounded-2xl p-4 text-center transition border";
      const active = "hover:bg-gray-50";
      const off = "border-dashed text-gray-300 pointer-events-none select-none";
      return (
        <a href={href||"#"} className={[base, muted?off:active].join(" ")}>
          {img ? (
            <img src={img} alt="" className={"w-10 h-10 mx-auto rounded " + (muted?"opacity-40":"")} />
          ) : (
            <div className={"text-3xl font-bold " + (muted?"opacity-40":"")}>{icon || "Ôºã"}</div>
          )}
          {title && <div className="font-semibold mt-2">{title}</div>}
          {sub && <div className="text-xs text-gray-500 mt-0.5">{sub}</div>}
        </a>
      );
    };

    const installUrl = (location.origin + location.pathname).replace(/#.*$/,'');

    return (
      <main className="max-w-md mx-auto p-4">
        <Section title={t('home_apps')}>
          {/* Grille 2√ó2 : LMRA (HG), Premiers soins (HD), STOP (BG), Emplacement vide (BD) */}
          <div className="grid grid-cols-2 gap-4">
            <TileC href="#lmra" icon="ü¶∫" title={t('tile_lmra_title')} sub={t('tile_lmra_sub')} />
            <TileC href="#firstaid" img="firstaid-icon.svg" title={t('tile_fa_title')} sub={t('tile_fa_sub')} />
            <TileC href="#stop" icon="üö¶" title={t('tile_stop_title')} sub={t('tile_stop_sub')} />
            <TileC muted img="" />
          </div>
        </Section>

        <Section title={t('home_install')}>
          <div className="flex flex-col items-center gap-3">
            <img
              src={"https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(installUrl)}
              alt="QR"
              className="w-44 h-44 rounded-lg border bg-white"
            />
            <div className="text-xs text-gray-500">{t('home_scan')}</div>
          </div>
        </Section>

        <Section title={t('install_howto_title')}>
          <pre className="whitespace-pre-wrap text-xs bg-gray-50 rounded-xl p-3 border">
            {t('install_howto_body')}
          </pre>
        </Section>
      </main>
    );
  }
</script>
<!-- ===== FIN PARTIE 2/5 ===== -->



<!-- ===== DEBUT PARTIE 3/5 : LMRA (Team/Permits/Energies/Env/Ops/Measures + Screen) ===== -->
<!-- ===== DEBUT PARTIE 3/5 : LMRA ===== -->
<script type="text/babel" data-presets="env,react">
  function LmraScreen(){
    const { t } = useI18n();

    // --- Storage keys d√©di√©s LMRA
    const STATE_KEY = "qhse_lmra_state_v1";

    // --- Pr√©f√©rences globales (d√©finies en PARTIE 1/5)
    const prefs = loadLS(PREFS_KEY, { responsable:"", team:[] });

    const nowLocalDateTime = () => {
      const d=new Date(), pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    const initialState = () => ({
      version: "v3.2",
      datetime: nowLocalDateTime(),
      site: "", task: "",
      responsable: prefs.responsable || "",
      team: Array.isArray(prefs.team) ? [...prefs.team] : [],
      teamInput: "",
      conditions: { tacheClaires:false, coactivite:false, zonage:false, epi:false },
      permits: { feu:false, electrique:false, confine:false, levage:false, autre:false, autreText:"", na:false },
      risks: {
        energies: { electrique:false, mecanique:false, fluide:false, gravite:false, autre:false, autreText:"" },
        environnement: { hauteur:false, meteo:false, bruit:false, poussiere:false, thermique:false, chimique:false },
        operations: { trafic:false, levage:false, outillage:false, atex:false, confine:false, autres:false, autresText:"" },
      },
      measures: { septRegles:false, ventilation:false, terre:false, balisage:false, surveillant:false, planLevage:false, ancrage:false, outilsOk:false, autre:false, autreText:"" },
      top3: [ { risk:"", action:"", resp:"" }, { risk:"", action:"", resp:"" }, { risk:"", action:"", resp:"" } ],
      decision: "GO",
      noGo: { name:"", tel:"" },
      notes: "",
    });

    const [data, setData] = React.useState(loadLS(STATE_KEY, initialState()));
    const [step, setStep] = React.useState(0);
    const totalSteps = 6;
    React.useEffect(()=>{ saveLS(STATE_KEY, data); }, [data]);

    const setField = (k,v)=>setData({...data,[k]:v});
    const resetAll = () => { setData(initialState()); setStep(0); };

    const envoyer = async () => {
      const payload = {
        meta: { sentAt:new Date().toISOString(), page:location.href, userAgent:navigator.userAgent, formType:"lmra" },
        data
      };
      const ok = await sendNow(payload);
      if(ok){
        alert(t('alert_sent'));
        // Conserver Responsable & √âquipe (prefs)
        saveLS(PREFS_KEY, { responsable:data.responsable, team:data.team });
        // Reset du reste, en r√©-injectant prefs
        setData(initialState());
        setStep(0);
      }else{
        enqueueOutbox(payload);
        alert(t('alert_offline_queued'));
      }
    };

    return (
      <main className="max-w-md mx-auto p-4">
        <h1 className="mb-3 px-4 py-2 rounded-xl bg-[#104861] text-[#D9D9D9]">{t('lmra_title')}</h1>
        {/* Bouton reset tout en haut (UX) */}
        <div className="mb-3">
          <button onClick={resetAll} className="px-3 py-2 rounded-xl border">{t('reset_all')}</button>
          <div className="text-xs text-gray-500 mt-1">{t('reset_hint_team')}</div>
        </div>
        <div className="mb-4">
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div className="bg-black h-2 rounded-full" style={{width: `${((step+1)/totalSteps)*100}%`}}></div>
          </div>
          <div className="text-center text-xs mt-1">{step+1}/{totalSteps}</div>
        </div>

        {step===0 && (
          <Section title={t('general_info')}>
            <div className="flex flex-col gap-3">
            <label className="text-sm">{t('datetime')}
              <input type="datetime-local" value={data.datetime} onChange={(e)=>setField("datetime", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('site')}
              <input value={data.site} onChange={(e)=>setField("site", e.target.value)} placeholder={t('site_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('task')}
              <input value={data.task} onChange={(e)=>setField("task", e.target.value)} placeholder={t('task_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('manager')}
              <input value={data.responsable} onChange={(e)=>setField("responsable", e.target.value)} placeholder={t('manager_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>

            {/* √âquipe */}
            <div>
              <label className="text-sm block mb-2">{t('team')}</label>
              <div className="flex gap-2 mb-2">
                <input value={data.teamInput} onChange={(e)=>setData({...data, teamInput:e.target.value})} placeholder={t('team_member_ph')} className="flex-1 px-3 py-2 rounded-xl border" />
                <button onClick={()=>{ const name=data.teamInput.trim(); if(!name) return; if(data.team.includes(name)) return setData({...data, teamInput:""}); setData({...data, team:[...data.team, name], teamInput:""}); }} className="px-3 py-2 rounded-xl border">{t('team_add')}</button>
              </div>
              <div className="flex flex-wrap gap-2">
                {data.team.map((n)=>(
                  <span key={n} className="inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full bg-gray-100">
                    {n}
                    <button onClick={()=>setData({...data, team: data.team.filter(x=>x!==n)})} className="w-5 h-5 inline-flex items-center justify-center rounded-full border border-gray-300">√ó</button>
                  </span>
                ))}
                {!data.team.length && <span className="text-sm text-gray-400">{t('team_empty')}</span>}
              </div>
            </div>
          </div>
        </Section>
        )}

        {step===1 && (
        <Section title={t('cond_title')}>
          <div className="flex flex-col gap-3">
            <Toggle checked={data.conditions.tacheClaires} onChange={(v)=>setData({...data, conditions:{...data.conditions, tacheClaires:v}})} label={t('cond_task_clear')} />
            <Toggle checked={data.conditions.coactivite}  onChange={(v)=>setData({...data, conditions:{...data.conditions, coactivite:v}})}   label={t('cond_coactivity')} />
            <Toggle checked={data.conditions.zonage}      onChange={(v)=>setData({...data, conditions:{...data.conditions, zonage:v}})}       label={t('cond_zone')} />
            <Toggle checked={data.conditions.epi}         onChange={(v)=>setData({...data, conditions:{...data.conditions, epi:v}})}          label={t('cond_epi')} />
            <hr className="my-3 border-gray-200" />
            {/* Permis */}
            <div>
              <div className="text-sm font-medium mb-2">{t('permits_title')}</div>
              <div className="grid grid-cols-2 gap-2">
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.feu} onChange={(e)=>setData({...data, permits:{...data.permits, feu:e.target.checked}})} />{t('permit_fire')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.electrique} onChange={(e)=>setData({...data, permits:{...data.permits, electrique:e.target.checked}})} />{t('permit_elec')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.confine} onChange={(e)=>setData({...data, permits:{...data.permits, confine:e.target.checked}})} />{t('permit_confined')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.levage} onChange={(e)=>setData({...data, permits:{...data.permits, levage:e.target.checked}})} />{t('permit_lift')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.autre} onChange={(e)=>setData({...data, permits:{...data.permits, autre:e.target.checked}})} />{t('permit_other')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.na} onChange={(e)=>setData({...data, permits:{...data.permits, na:e.target.checked}})} />{t('permit_na')}</label>
              </div>
              {data.permits.autre && (
                <input value={data.permits.autreText} onChange={(e)=>setData({...data, permits:{...data.permits, autreText:e.target.value}})} placeholder={t('permit_other_ph')} className="mt-2 w-full px-3 py-2 rounded-xl border" />
              )}
            </div>
          </div>
        </Section>
        )}

        {step===2 && (
        <Section title={t('risks_title')}>
          <div className="flex flex-col gap-3">
            {/* √ânergies */}
            <div>
              <div className="text-sm font-medium mb-2">{t('energies_title')}</div>
              <div className="grid grid-cols-2 gap-2">
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.energies.electrique} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, electrique:e.target.checked}}})} />{t('energy_electric')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.energies.mecanique} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, mecanique:e.target.checked}}})} />{t('energy_mechanical')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.energies.fluide} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, fluide:e.target.checked}}})} />{t('energy_fluid')}</label>
                <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.energies.gravite} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, gravite:e.target.checked}}})} />{t('energy_gravity')}</label>
                <label className="flex items-center gap-2 text-sm col-span-2"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.energies.autre} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, autre:e.target.checked}}})} />{t('other')}</label>
              </div>
              {data.risks.energies.autre && (
                <input value={data.risks.energies.autreText} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, autreText:e.target.value}}})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border" />
              )}
            </div>

            <hr className="my-3 border-gray-200" />

            {/* Environnement */}
            <div>
              <div className="text-sm font-medium mb-2">{t('env_title')}</div>
              <div className="grid grid-cols-2 gap-2">
                {[
                  ['hauteur','env_height'],['meteo','env_weather'],['bruit','env_noise'],
                  ['poussiere','env_dust'],['thermique','env_thermal'],['chimique','env_chemical']
                ].map(([k,label])=>(
                  <label key={k} className="flex items-center gap-2 text-sm">
                    <input type="checkbox" className="w-4 h-4 accent-black"
                      checked={data.risks.environnement[k]}
                      onChange={(e)=>setData({...data, risks:{...data.risks, environnement:{...data.risks.environnement, [k]:e.target.checked}}})} />
                    {t(label)}
                  </label>
                ))}
              </div>
            </div>

            <hr className="my-3 border-gray-200" />

            {/* Op√©rations */}
            <div>
              <div className="text-sm font-medium mb-2">{t('ops_title')}</div>
              <div className="grid grid-cols-2 gap-2">
                {[
                  ['trafic','ops_traffic'],['levage','ops_lift'],['outillage','ops_tools'],
                  ['atex','ops_atex'],['confine','ops_confined']
                ].map(([k,label])=>(
                  <label key={k} className="flex items-center gap-2 text-sm">
                    <input type="checkbox" className="w-4 h-4 accent-black"
                      checked={data.risks.operations[k]}
                      onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, [k]:e.target.checked}}})} />
                    {t(label)}
                  </label>
                ))}
                <label className="flex items-center gap-2 text-sm col-span-2">
                  <input type="checkbox" className="w-4 h-4 accent-black"
                    checked={data.risks.operations.autres}
                    onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, autres:e.target.checked}}})} />
                  {t('ops_others')}
                </label>
              </div>
              {data.risks.operations.autres && (
                <input value={data.risks.operations.autresText} onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, autresText:e.target.value}}})} placeholder={t('ops_others_ph')} className="mt-2 w-full px-3 py-2 rounded-xl border" />
              )}
            </div>
          </div>
        </Section>
        )}

        {step===3 && (
        <Section title={t('measures_title')}>
          <div className="grid grid-cols-2 gap-2">
            {[
              ['septRegles','measures_seven'],['ventilation','measures_ventilation'],
              ['terre','measures_earth'],['balisage','measures_balisage'],
              ['surveillant','measures_watch'],['planLevage','measures_liftplan'],
              ['ancrage','measures_anchor'],['outilsOk','measures_toolsok']
            ].map(([k,label])=>(
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black"
                  checked={data.measures[k]}
                  onChange={(e)=>setData({...data, measures:{...data.measures, [k]:e.target.checked}})} />
                {t(label)}
              </label>
            ))}
            <label className="flex items-center gap-2 text-sm col-span-2">
              <input type="checkbox" className="w-4 h-4 accent-black"
                checked={data.measures.autre}
                onChange={(e)=>setData({...data, measures:{...data.measures, autre:e.target.checked}})} />
              {t('other')}
            </label>
            {data.measures.autre && (
              <input value={data.measures.autreText} onChange={(e)=>setData({...data, measures:{...data.measures, autreText:e.target.value}})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border col-span-2" />
            )}
          </div>
        </Section>
        )}

        {step===4 && (
        <Section title={t('top3_title')}>
          <div className="flex flex-col gap-2">
            {data.top3.map((it,i)=>(
              <div key={i} className="grid grid-cols-1 gap-2">
                <div className="text-sm font-medium">#{i+1}</div>
                <input value={it.risk} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], risk:e.target.value}; setField("top3", top3); }} placeholder={t('risk_ph')} className="px-3 py-2 rounded-xl border" />
                <input value={it.action} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], action:e.target.value}; setField("top3", top3); }} placeholder={t('action_ph')} className="px-3 py-2 rounded-xl border" />
                <input value={it.resp} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], resp:e.target.value}; setField("top3", top3); }} placeholder={t('resp_ph')} className="px-3 py-2 rounded-xl border" />
                <hr className="my-2 border-gray-200" />
              </div>
            ))}
          </div>
        </Section>
        )}

        {step===5 && (
        <Section title={t('decision_title')}>
          <div className="flex flex-col gap-3">
            <div className="flex items-center gap-3">
              <button onClick={()=>setField("decision","GO")} className={"px-4 py-2 rounded-xl border "+(data.decision==="GO"?"bg-green-50 border-green-300":"")}>{t('go')}</button>
              <button onClick={()=>setField("decision","NO-GO")} className={"px-4 py-2 rounded-xl border "+(data.decision==="NO-GO"?"bg-red-50 border-red-300":"")}>{t('no_go')}</button>
            </div>
            {data.decision==="NO-GO" && (
              <div className="grid grid-cols-1 gap-2">
                <input value={data.noGo.name} onChange={(e)=>setField("noGo",{...data.noGo, name:e.target.value})} placeholder={t('nogo_name_ph')} className="px-3 py-2 rounded-xl border" />
                <input value={data.noGo.tel}  onChange={(e)=>setField("noGo",{...data.noGo, tel:e.target.value})}  placeholder={t('nogo_tel_ph')}  className="px-3 py-2 rounded-xl border" />
              </div>
            )}
            <label className="text-sm">{t('manager')}
              <input value={data.responsable} onChange={(e)=>setField("responsable", e.target.value)} placeholder={t('manager_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('notes')}
              <textarea value={data.notes} onChange={(e)=>setField("notes", e.target.value)} rows={2} placeholder={t('notes_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </div>
        </Section>
        )}

        <div className={"flex mt-4 " + (step>0 ? "justify-between" : "justify-end")}>
          {step>0 && (
            <button onClick={()=>setStep(step-1)} className="px-3 py-2 rounded-xl border">{t('prev')}</button>
          )}
          {step<totalSteps-1 ? (
            <button onClick={()=>setStep(step+1)} className="px-3 py-2 rounded-xl border">{t('next')}</button>
          ) : (
            <button onClick={envoyer} className="px-4 py-3 rounded-xl border bg-black text-white">{t('send')}</button>
          )}
        </div>
      </main>
    );
  }
</script>
<!-- ===== FIN PARTIE 3/5 ===== -->
<!-- ===== DEBUT PARTIE 4/5 : PREMIERS SOINS + STOP ===== -->
<script type="text/babel" data-presets="env,react">
  /* ======================= PREMIERS SOINS ======================= */
  function FirstAidScreen(){
    const { t } = useI18n();

    const STATE_KEY = "qhse_firstaid_state_v1";
    const prefs = loadLS(PREFS_KEY, { responsable:"", team:[] });

    const nowLocalDateTime = () => {
      const d=new Date(), pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    const initialState = () => ({
      datetime: nowLocalDateTime(),
      chantier: "",
      responsable: prefs.responsable || "",
      personne: "",
      actions: { coupant:false, disquant:false, soudant:false, percant:false, tirant:false, soulevant:false, autre:false, autreText:"" },
      blessures: { coupure:false, egratignure:false, contusion:false, projection:false, brulure:false, autre:false, autreText:"" },
      localisation: { main:false, bras:false, torse:false, jambe:false, pied:false, tete:false, oeil:false, autre:false, autreText:"" },
      recharge: false,
      trousseNumero: "",
      remarques: ""
    });

    const [data, setData] = React.useState(loadLS(STATE_KEY, initialState()));
    React.useEffect(()=>{ saveLS(STATE_KEY, data); }, [data]);

    const setField = (k,v)=>setData({...data,[k]:v});
    const resetAll = () => setData(initialState());

    const envoyer = async () => {
      const payload = {
        meta: { sentAt:new Date().toISOString(), page:location.href, userAgent:navigator.userAgent, formType:"firstaid" },
        data
      };
      const ok = await sendNow(payload);
      if(ok){
        alert(t('alert_sent'));
        // Conserver responsable (prefs)
        saveLS(PREFS_KEY, { ...loadLS(PREFS_KEY, {responsable:"", team:[]}), responsable:data.responsable });
        setData(initialState());
      }else{
        enqueueOutbox(payload);
        alert(t('alert_offline_queued'));
      }
    };

    return (
      <main className="max-w-md mx-auto p-4">
        <h1 className="mb-3 px-4 py-2 rounded-xl bg-[#104861] text-[#D9D9D9]">{t('fa_title')}</h1>
        <div className="mb-3">
          <button onClick={resetAll} className="px-3 py-2 rounded-xl border">{t('reset_all')}</button>
        </div>

        <Section title={t('fa_info')}>
          <div className="flex flex-col gap-3">
            <label className="text-sm">{t('datetime')}
              <input type="datetime-local" value={data.datetime} onChange={(e)=>setField("datetime", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('site')}
              <input value={data.chantier} onChange={(e)=>setField("chantier", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('manager')}
              <input value={data.responsable} onChange={(e)=>setField("responsable", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('person')}
              <input value={data.personne} onChange={(e)=>setField("personne", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </div>
        </Section>

        <Section title={t('action_title')}>
          <div className="grid grid-cols-2 gap-2">
            {[
              ['coupant','a_cut'],['disquant','a_grind'],['soudant','a_weld'],
              ['percant','a_drill'],['tirant','a_pushpull'],['soulevant','a_lift']
            ].map(([k,label])=>(
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black"
                  checked={data.actions[k]}
                  onChange={(e)=>setField("actions", {...data.actions, [k]:e.target.checked})} />
                {t(label)}
              </label>
            ))}
            <label className="flex items-center gap-2 text-sm col-span-2">
              <input type="checkbox" className="w-4 h-4 accent-black"
                checked={data.actions.autre}
                onChange={(e)=>setField("actions", {...data.actions, autre:e.target.checked})} />
              {t('other')}
            </label>
            {data.actions.autre && (
              <input value={data.actions.autreText} onChange={(e)=>setField("actions", {...data.actions, autreText:e.target.value})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border col-span-2" />
            )}
          </div>
        </Section>

        <Section title={t('injury_title')}>
          <div className="grid grid-cols-2 gap-2">
            {[
              ['coupure','i_cut'],['egratignure','i_scratch'],['contusion','i_bruise'],
              ['projection','i_proj'],['brulure','i_burn']
            ].map(([k,label])=>(
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black"
                  checked={data.blessures[k]}
                  onChange={(e)=>setField("blessures", {...data.blessures, [k]:e.target.checked})} />
                {t(label)}
              </label>
            ))}
            <label className="flex items-center gap-2 text-sm col-span-2">
              <input type="checkbox" className="w-4 h-4 accent-black"
                checked={data.blessures.autre}
                onChange={(e)=>setField("blessures", {...data.blessures, autre:e.target.checked})} />
              {t('other')}
            </label>
            {data.blessures.autre && (
              <input value={data.blessures.autreText} onChange={(e)=>setField("blessures", {...data.blessures, autreText:e.target.value})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border col-span-2" />
            )}
          </div>
        </Section>

        <Section title={t('location_title')}>
          <div className="grid grid-cols-2 gap-2">
            {[
              ['main','loc_hand'],['bras','loc_arm'],['torse','loc_torso'],
              ['jambe','loc_leg'],['pied','loc_foot'],['tete','loc_head'],['oeil','loc_eye']
            ].map(([k,label])=>(
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black"
                  checked={data.localisation[k]}
                  onChange={(e)=>setField("localisation", {...data.localisation, [k]:e.target.checked})} />
                {t(label)}
              </label>
            ))}
            <label className="flex items-center gap-2 text-sm col-span-2">
              <input type="checkbox" className="w-4 h-4 accent-black"
                checked={data.localisation.autre}
                onChange={(e)=>setField("localisation", {...data.localisation, autre:e.target.checked})} />
              {t('other')}
            </label>
            {data.localisation.autre && (
              <input value={data.localisation.autreText} onChange={(e)=>setField("localisation", {...data.localisation, autreText:e.target.value})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border col-span-2" />
            )}
          </div>
        </Section>

        <Section title={t('kit_title')}>
          <div className="flex flex-col gap-3">
            <div className="flex items-center gap-3">
              <span className="text-sm">{t('kit_need')}</span>
              <label className="text-sm inline-flex items-center gap-1">
                <input type="radio" name="recharge" checked={!data.recharge} onChange={()=>setField("recharge", false)} /> {t('no')}
              </label>
              <label className="text-sm inline-flex items-center gap-1">
                <input type="radio" name="recharge" checked={data.recharge} onChange={()=>setField("recharge", true)} /> {t('yes')}
              </label>
            </div>
            {data.recharge && (
              <label className="text-sm">{t('kit_number')}
                <input value={data.trousseNumero} onChange={(e)=>setField("trousseNumero", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
            )}
          </div>
        </Section>

        <Section title={t('remarks')}>
          <textarea value={data.remarques} onChange={(e)=>setField("remarques", e.target.value)} rows={3} className="w-full px-3 py-2 rounded-xl border" />
        </Section>

        <div className="grid grid-cols-1 gap-2 mt-4">
          <button onClick={envoyer} className="px-4 py-3 rounded-xl border bg-black text-white">{t('send')}</button>
        </div>
      </main>
    );
  }

  /* ======================= STOP ======================= */
  function StopScreen(){
    const { t } = useI18n();

    const STATE_KEY = "qhse_stop_state_v1";
    const prefs = loadLS(PREFS_KEY, { responsable:"", team:[] });

    const nowLocalDateTime = () => {
      const d=new Date(), pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    const initialState = () => ({
      datetime: nowLocalDateTime(),
      chantier: "",
      responsable: prefs.responsable || "",
      situation: "",
      callNom: "",
      callFonction: "chef", // chef/site/pm/opm/cp/coord/client
      solution: "",
      noGo: ""
    });

    const [data, setData] = React.useState(loadLS(STATE_KEY, initialState()));
    React.useEffect(()=>{ saveLS(STATE_KEY, data); }, [data]);

    const setField = (k,v)=>setData({...data,[k]:v});
    const resetAll = () => setData(initialState());

    const envoyer = async () => {
      const payload = {
        meta: { sentAt:new Date().toISOString(), page:location.href, userAgent:navigator.userAgent, formType:"stop" },
        data
      };
      const ok = await sendNow(payload);
      if(ok){
        alert(t('alert_sent'));
        // Conserver responsable en prefs
        saveLS(PREFS_KEY, { ...loadLS(PREFS_KEY, {responsable:"", team:[]}), responsable:data.responsable });
        setData(initialState());
      }else{
        enqueueOutbox(payload);
        alert(t('alert_offline_queued'));
      }
    };

    return (
      <main className="max-w-md mx-auto p-4">
        <h1 className="mb-3 px-4 py-2 rounded-xl bg-[#104861] text-[#D9D9D9]">{t('stop_title')}</h1>
        <div className="mb-3">
          <button onClick={resetAll} className="px-3 py-2 rounded-xl border">{t('reset_all')}</button>
        </div>

        <Section title={t('coords')}>
          <div className="flex flex-col gap-3">
            <label className="text-sm">{t('datetime')}
              <input type="datetime-local" value={data.datetime} onChange={(e)=>setField("datetime", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('site')}
              <input value={data.chantier} onChange={(e)=>setField("chantier", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('manager')}
              <input value={data.responsable} onChange={(e)=>setField("responsable", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </div>
        </Section>

        <Section title={t('stop_box')} tone="red">
          <textarea value={data.situation} onChange={(e)=>setField("situation", e.target.value)} rows={3} placeholder={t('stop_desc')} className="w-full px-3 py-2 rounded-xl border" />
        </Section>

        <Section title={t('call_box')} tone="amber">
          <div className="grid grid-cols-1 gap-3">
            <label className="text-sm">{t('call_name')}
              <input value={data.callNom} onChange={(e)=>setField("callNom", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('call_role')}
              <select value={data.callFonction} onChange={(e)=>setField("callFonction", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border">
                <option value="chef">{t('role_chef')}</option>
                <option value="site">{t('role_site')}</option>
                <option value="pm">{t('role_pm')}</option>
                <option value="opm">{t('role_opm')}</option>
                <option value="cp">{t('role_cp')}</option>
                <option value="coord">{t('role_coord')}</option>
                <option value="client">{t('role_client')}</option>
              </select>
            </label>
          </div>
        </Section>

        <Section title={t('act_box')} tone="green">
          <div className="flex flex-col gap-3">
            <label className="text-sm">{t('solution')}
              <textarea value={data.solution} onChange={(e)=>setField("solution", e.target.value)} rows={3} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('nogo_wait')}
              <textarea value={data.noGo} onChange={(e)=>setField("noGo", e.target.value)} rows={2} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </div>
        </Section>

        <div className="grid grid-cols-1 gap-2 mt-4">
          <button onClick={envoyer} className="px-4 py-3 rounded-xl border bg-black text-white">{t('send')}</button>
        </div>
      </main>
    );
  }
</script>
<!-- ===== FIN PARTIE 4/5 ===== -->




<!-- ===== DEBUT PARTIE 5/5 : APP SHELL + HEADER + RENDER (UX align√©e) ===== -->
<script type="text/babel" data-presets="env,react">
  // Logo seul (pas de texte redondant)
  function Brand(){
    return (
      <a href="#home" className="flex items-center gap-2" aria-label="QHSE">
        <img src="qhse-logo.svg" alt="" className="w-8 h-8 rounded-lg border"
             onError={(e)=>{ e.currentTarget.replaceWith(Object.assign(document.createElement('span'),{className:'inline-flex items-center justify-center w-8 h-8 rounded-lg border font-bold', innerText:'QHSE'})); }} />
      </a>
    );
  }

  // === LangPicker (images SVG locales) ===
  function LangPicker(){
    const { lang, setLang } = useI18n();
  
    const Btn = ({code, src, alt}) => (
      <button
        onClick={()=>setLang(code)}
        className={
          "w-9 h-9 flex items-center justify-center rounded-lg border " +
          (lang===code ? "bg-black" : "bg-white")
        }
        aria-label={code.toUpperCase()}
        title={code.toUpperCase()}
      >
        <img src={src} alt={alt} className="w-6 h-4 rounded-sm pointer-events-none select-none" />
      </button>
    );
  
    return (
      <div className="flex items-center gap-1.5">
        <Btn code="fr" src="flag-fr.svg" alt="FR" />
        <Btn code="en" src="flag-gb.svg" alt="EN" />
        <Btn code="nl" src="flag-nl.svg" alt="NL" />
      </div>
    );
  }


  function App(){
    const { t } = useI18n();
    const [route,setRoute] = React.useState(parseRoute());
    React.useEffect(()=>{
      const onHash=()=>setRoute(parseRoute());
      window.addEventListener('hashchange', onHash);
      return ()=>window.removeEventListener('hashchange', onHash);
    },[]);
    return (
      <div>
        <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
          <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-between gap-3">
            <Brand />
            <div className="flex items-center gap-3">
              <LangPicker />
              <button onClick={()=>window.print()} className="px-3 py-1.5 rounded-xl border">{t('print')}</button>
            </div>
          </div>
        </header>

        {route==='home' && <HomeScreen/>}
        {route==='lmra' && <LmraScreen/>}
        {route==='firstaid' && <FirstAidScreen/>}
        {route==='stop' && <StopScreen/>}

        <footer className="max-w-md mx-auto px-4 pb-8 text-center text-xs text-gray-400">
          QHSE PWA ‚Ä¢ Donn√©es locales + collecte centrale
        </footer>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<I18nProvider><App/></I18nProvider>);
</script>
<!-- ===== FIN PARTIE 5/5 ===== -->

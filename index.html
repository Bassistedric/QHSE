<!-- ===== DEBUT PARTIE 1/5 : HTML + CDN + SW + CONFIG/I18N/HELPERS ===== -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>QHSE ‚Äì Apps</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print{header,footer,.no-print{display:none!important}main{max-width:100%!important}section{page-break-inside:avoid}}
    .card{ @apply bg-white rounded-2xl shadow p-4 mb-4; }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="root"></div>

  <!-- PWA / Service Worker (bump ?v=... pour forcer la MAJ) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () =>
        navigator.serviceWorker.register('./sw.js?v=v4-lang-emoji-2').catch(console.error)
      );
    }
  </script>

  <!-- React + Babel (CDN principal) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- ===== SCRIPT 1 : CONFIG, I18N, ROUTER, HELPERS ===== -->
  <script type="text/babel" data-presets="env,react">
    // ========================= CONFIG =========================
    // ‚¨á‚¨á Remplacer l' URL Apps Script /exec si modification du GSheet
    const COLLECT_URL = "https://script.google.com/macros/s/AKfycbw53EiERifnozNg9ybNfbn_Ofm9NrFquashw_mbYoWyqtQROS6xXXzwVT2UQ4XxcJYK/exec";

    const STORAGE_KEY     = "qhse_current_v1";
    const OUTBOX_KEY      = "qhse_outbox_v1";
    const PREFS_KEY       = "qhse_prefs_v1"; // conserve Responsable & √âquipe
    const LANG_KEY        = "qhse_lang_v1";  // fr/en/nl

    // ========================= I18N (FR/EN/NL) =========================
    // >>> ensemble des libell√©s ici, FR par d√©faut.
     if (!window.QHSE_I18N) {
    window.QHSE_I18N = {
      fr: {

    // Accueil / global
    home_title: "QHSE ‚Äì Apps chantier",
    home_apps: "Applications chantier",
    home_install: "Installer sur mobile",
    home_scan: "Scannez avec l‚Äôappareil photo pour ouvrir l‚Äôapp.",
    install_howto_title: "Installer sur le t√©l√©phone",
    install_howto_body:
`Ouvre l‚ÄôURL sur le mobile (en ligne, 1 ≥·µâ fois) ‚Üí
 iPhone (Safari) : Partager ‚Üí Sur l‚Äô√©cran d‚Äôaccueil.
 Android (Chrome) : ‚ãÆ ‚Üí Ajouter √† l‚Äô√©cran d‚Äôaccueil.
Ensuite, l‚Äôapp peut fonctionner hors-ligne.`,

    tile_lmra_title: "LMRA",
    tile_lmra_sub: "Analyse de risque",
    tile_fa_title: "Premiers soins",
    tile_fa_sub: "Utilisation trousse",
    tile_stop_title: "STOP chantier",
    tile_stop_sub: "Impr√©vu / arr√™t",

    print: "Imprimer",
    reset_all: "R√©initialiser le formulaire (tout remettre √† z√©ro)",
    reset_hint_team: "√Ä utiliser si l‚Äô√©quipe change (Responsable & √âquipe seront vid√©s).",
    send: "Envoyer",
    sending: "Envoi en cours‚Ä¶",
    queue_label: "File",

    // Alerts
    alert_sent: "Envoy√© ‚úÖ",
    alert_offline_queued: "Pas de r√©seau : enregistr√© localement. Envoi auto d√®s connexion.",

    // LMRA
    lmra_title: "LMRA ‚Äì Mobile (v3.2)",
    general_info: "Infos g√©n√©rales",
    datetime: "Date & heure",
    site: "Site / Zone",
    site_ph: "Ex: B√¢t. A ‚Äì Toiture",
    task: "T√¢che",
    task_ph: "Ex: Remplacement moteur ventilo",
    manager: "Responsable (Nom & Pr√©nom)",
    manager_ph: "Ex: Jean Dupont",
    team: "√âquipe",
    team_member_ph: "Nom & pr√©nom",
    team_add: "Ajouter",
    team_empty: "(Ajouter les membres)",

    cond_title: "Conditions du jour",
    cond_task_clear: "T√¢che & √©tapes claires",
    cond_coactivity: "Co-activit√© / interfaces g√©r√©es",
    cond_zone: "Zone balis√©e / acc√®s ma√Ætris√©",
    cond_epi: "EPI adapt√©s port√©s",

    permits_title: "Permis requis",
    permit_fire: "Feu",
    permit_elec: "√âlectrique",
    permit_confined: "Espace confin√©",
    permit_lift: "Levage",
    permit_other: "Autre",
    permit_other_ph: "Pr√©ciser l‚Äôautre permis",
    permit_na: "N/A",

    risks_title: "Risques pr√©sents",
    energies_title: "√ânergies",
    energy_electric: "√âlectrique",
    energy_mechanical: "M√©canique",
    energy_fluid: "Hydraulique/Pneumatique",
    energy_gravity: "Gravit√©",

    env_title: "Environnement",
    env_height: "Hauteur",
    env_weather: "Vent/M√©t√©o",
    env_noise: "Bruit",
    env_dust: "Poussi√®res",
    env_thermal: "Chaleur/Froid",
    env_chemical: "Produits chimiques",

    ops_title: "Op√©rations",
    ops_traffic: "Circulation / engins",
    ops_lift: "Levage",
    ops_tools: "Outillage portatif",
    ops_atex: "ATEX",
    ops_confined: "Espace confin√©",
    ops_others: "Autres",
    ops_others_ph: "Pr√©ciser autres op√©rations",

    measures_title: "Mesures de ma√Ætrise",
    measures_seven: "7 r√®gles consignation + test",
    measures_ventilation: "Ventilation / mesure gaz",
    measures_earth: "Mise √† la terre",
    measures_balisage: "Balisage / zonage",
    measures_watch: "Observateur / surveillant",
    measures_liftplan: "Plan de levage / CMU v√©rifi√©e",
    measures_anchor: "Ancrage / chutes d‚Äôobjets",
    measures_toolsok: "Outils conformes / inspection",
    measures_other: "Autre",
    measures_other_ph: "Pr√©ciser autre mesure",

    top3_title: "Top 3 risques & actions",
    risk_ph: "Risque",
    action_ph: "Action imm√©diate",
    resp_ph: "Responsable",

    decision_title: "D√©cision & responsable",
    go: "GO",
    no_go: "NO-GO",
    nogo_name: "Nom √† pr√©venir",
    nogo_name_ph: "Nom √† pr√©venir",
    nogo_tel: "T√©l√©phone",
    nogo_tel_ph: "T√©l√©phone",
    notes: "Notes",
    notes_ph: "Observations‚Ä¶",

    // First aid
    fa_title: "Premiers soins",
    fa_info: "Informations",
    person: "Personne concern√©e",
    action_title: "Action (au moment du fait)",
    a_cut: "En coupant",
    a_grind: "En disquant",
    a_weld: "En soudant",
    a_drill: "En per√ßant",
    a_pushpull: "En tirant/poussant",
    a_lift: "En soulevant/d√©posant",
    other: "Autre",
    other_specify: "Pr√©ciser‚Ä¶",
    injury_title: "Blessure",
    i_cut: "Coupure",
    i_scratch: "√âgratignure",
    i_bruise: "Contusion (bleu/bosse)",
    i_proj: "Projection (poussi√®re/mati√®re)",
    i_burn: "Br√ªlure",
    location_title: "Localisation de la l√©sion",
    loc_hand: "Main",
    loc_arm: "Bras",
    loc_torso: "Torse",
    loc_leg: "Jambe",
    loc_foot: "Pied",
    loc_head: "T√™te",
    loc_eye: "≈íil",
    kit_title: "Trousse de secours",
    kit_need: "Faut-il recharger la trousse ?",
    no: "Non",
    yes: "Oui",
    kit_number: "Num√©ro de la trousse",
    remarks: "Remarques",

    // STOP
    stop_title: "STOP ‚Äì Impr√©vu",
    coords: "Coordonn√©es",
    stop_box: "STOP",
    stop_desc: "Expliquer la situation qui a amen√© au STOP",
    call_box: "CALL",
    call_name: "Responsable contact√© ‚Äì Nom",
    call_role: "Fonction",
    role_chef: "Chef d'√©quipe",
    role_site: "Site sup.",
    role_pm: "PM",
    role_opm: "OPM",
    role_cp: "CP",
    role_coord: "Coordinateur",
    role_client: "Client",
    act_box: "ACT",
    solution: "Solution mise en place",
    nogo_wait: "NO-GO ‚Äî Situation en attente de solution",
  },

  en: {
    // Home / global
    home_title: "QHSE ‚Äì Site apps",
    home_apps: "Site applications",
    home_install: "Install on mobile",
    home_scan: "Scan with the camera to open the app.",
    install_howto_title: "Install on the phone",
    install_howto_body:
`Open the URL on the phone (online, first time) ‚Üí
 iPhone (Safari): Share ‚Üí Add to Home Screen.
 Android (Chrome): ‚ãÆ ‚Üí Add to Home screen.
Then, the app can work offline.`,

    tile_lmra_title: "LMRA",
    tile_lmra_sub: "Risk assessment",
    tile_fa_title: "First aid",
    tile_fa_sub: "First-aid kit use",
    tile_stop_title: "STOP",
    tile_stop_sub: "Unplanned / stop",

    print: "Print",
    reset_all: "Reset form (clear everything)",
    reset_hint_team: "Use this if the team changes (Manager & Team will be cleared).",
    send: "Send",
    sending: "Sending‚Ä¶",
    queue_label: "Queue",

    alert_sent: "Sent ‚úÖ",
    alert_offline_queued: "No network: saved locally. Will auto-send when online.",

    // LMRA
    lmra_title: "LMRA ‚Äì Mobile (v3.2)",
    general_info: "General info",
    datetime: "Date & time",
    site: "Site / Area",
    site_ph: "e.g. Building A ‚Äì Roof",
    task: "Task",
    task_ph: "e.g. Replace fan motor",
    manager: "Manager (First & Last name)",
    manager_ph: "e.g. John Smith",
    team: "Team",
    team_member_ph: "First & last name",
    team_add: "Add",
    team_empty: "(Add members)",

    cond_title: "Day conditions",
    cond_task_clear: "Task & steps are clear",
    cond_coactivity: "Co-activity / interfaces managed",
    cond_zone: "Area cordoned / access controlled",
    cond_epi: "PPE adapted and worn",

    permits_title: "Required permits",
    permit_fire: "Hot work",
    permit_elec: "Electrical",
    permit_confined: "Confined space",
    permit_lift: "Lifting",
    permit_other: "Other",
    permit_other_ph: "Specify the other permit",
    permit_na: "N/A",

    risks_title: "Present risks",
    energies_title: "Energies",
    energy_electric: "Electrical",
    energy_mechanical: "Mechanical",
    energy_fluid: "Hydraulic/Pneumatic",
    energy_gravity: "Gravity",

    env_title: "Environment",
    env_height: "Height",
    env_weather: "Wind/Weather",
    env_noise: "Noise",
    env_dust: "Dust",
    env_thermal: "Heat/Cold",
    env_chemical: "Chemicals",

    ops_title: "Operations",
    ops_traffic: "Traffic / vehicles",
    ops_lift: "Lifting",
    ops_tools: "Hand tools",
    ops_atex: "ATEX",
    ops_confined: "Confined space",
    ops_others: "Others",
    ops_others_ph: "Specify other operations",

    measures_title: "Control measures",
    measures_seven: "7 lockout rules + test",
    measures_ventilation: "Ventilation / gas measurement",
    measures_earth: "Earthing",
    measures_balisage: "Barricading / zoning",
    measures_watch: "Watchman / spotter",
    measures_liftplan: "Lift plan / SWL checked",
    measures_anchor: "Anchorage / falling objects",
    measures_toolsok: "Tools compliant / inspection",
    measures_other: "Other",
    measures_other_ph: "Specify other measure",

    top3_title: "Top 3 risks & actions",
    risk_ph: "Risk",
    action_ph: "Immediate action",
    resp_ph: "Responsible",

    decision_title: "Decision & manager",
    go: "GO",
    no_go: "NO-GO",
    nogo_name: "Person to notify",
    nogo_name_ph: "Person to notify",
    nogo_tel: "Phone",
    nogo_tel_ph: "Phone",
    notes: "Notes",
    notes_ph: "Observations‚Ä¶",

    // First aid
    fa_title: "First aid",
    fa_info: "Information",
    person: "Person concerned",
    action_title: "Action (at the time)",
    a_cut: "Cutting",
    a_grind: "Grinding",
    a_weld: "Welding",
    a_drill: "Drilling",
    a_pushpull: "Pulling/Pushing",
    a_lift: "Lifting/Setting down",
    other: "Other",
    other_specify: "Specify‚Ä¶",
    injury_title: "Injury",
    i_cut: "Cut",
    i_scratch: "Scratch",
    i_bruise: "Bruise (blue/bump)",
    i_proj: "Projection (dust/material)",
    i_burn: "Burn",
    location_title: "Injury location",
    loc_hand: "Hand",
    loc_arm: "Arm",
    loc_torso: "Torso",
    loc_leg: "Leg",
    loc_foot: "Foot",
    loc_head: "Head",
    loc_eye: "Eye",
    kit_title: "First-aid kit",
    kit_need: "Do we need to restock the kit?",
    no: "No",
    yes: "Yes",
    kit_number: "Kit number",
    remarks: "Remarks",

    // STOP
    stop_title: "STOP ‚Äì Unexpected",
    coords: "Details",
    stop_box: "STOP",
    stop_desc: "Explain the situation that led to STOP",
    call_box: "CALL",
    call_name: "Responsible contacted ‚Äì Name",
    call_role: "Role",
    role_chef: "Team leader",
    role_site: "Site supervisor",
    role_pm: "PM",
    role_opm: "OPM",
    role_cp: "CP",
    role_coord: "Coordinator",
    role_client: "Client",
    act_box: "ACT",
    solution: "Solution implemented",
    nogo_wait: "NO-GO ‚Äî Situation pending a solution",
  },

  nl: {
    // Home / global
    home_title: "QHSE ‚Äì Werf-apps",
    home_apps: "Werfapplicaties",
    home_install: "Installeren op mobiel",
    home_scan: "Scan met de camera om de app te openen.",
    install_howto_title: "Op de telefoon installeren",
    install_howto_body:
`Open de URL op de telefoon (online, eerste keer) ‚Üí
 iPhone (Safari): Delen ‚Üí Zet op beginscherm.
 Android (Chrome): ‚ãÆ ‚Üí Toevoegen aan startscherm.
Daarna kan de app offline werken.`,

    tile_lmra_title: "LMRA",
    tile_lmra_sub: "Risicoanalyse",
    tile_fa_title: "Eerste hulp",
    tile_fa_sub: "Gebruik EHBO-koffer",
    tile_stop_title: "STOP",
    tile_stop_sub: "Onvoorziene stop",

    print: "Afdrukken",
    reset_all: "Formulier resetten (alles wissen)",
    reset_hint_team: "Gebruik dit als het team wijzigt (Verantwoordelijke & Team worden leeggemaakt).",
    send: "Verzenden",
    sending: "Verzenden‚Ä¶",
    queue_label: "Wachtrij",

    alert_sent: "Verzonden ‚úÖ",
    alert_offline_queued: "Geen netwerk: lokaal opgeslagen. Wordt automatisch verzonden zodra online.",

    // LMRA
    lmra_title: "LMRA ‚Äì Mobiel (v3.2)",
    general_info: "Algemene info",
    datetime: "Datum & tijd",
    site: "Werf / Zone",
    site_ph: "Bv. Gebouw A ‚Äì Dak",
    task: "Taak",
    task_ph: "Bv. Vervangen ventilatormotor",
    manager: "Verantwoordelijke (Voor- & achternaam)",
    manager_ph: "Bv. Jan Jansen",
    team: "Team",
    team_member_ph: "Voor- & achternaam",
    team_add: "Toevoegen",
    team_empty: "(Voeg teamleden toe)",

    cond_title: "Dagcondities",
    cond_task_clear: "Taak & stappen zijn duidelijk",
    cond_coactivity: "Co-activiteit / interfaces beheerd",
    cond_zone: "Zone afgebakend / toegang beheerst",
    cond_epi: "Juiste PBM gedragen",

    permits_title: "Vereiste vergunningen",
    permit_fire: "Hete werken",
    permit_elec: "Elektrisch",
    permit_confined: "Besloten ruimte",
    permit_lift: "Hijswerk",
    permit_other: "Andere",
    permit_other_ph: "Specifieer de andere vergunning",
    permit_na: "N.v.t.",

    risks_title: "Aanwezige risico‚Äôs",
    energies_title: "Energie√´n",
    energy_electric: "Elektrisch",
    energy_mechanical: "Mechanisch",
    energy_fluid: "Hydraulisch/Pneumatisch",
    energy_gravity: "Zwaartekracht",

    env_title: "Omgeving",
    env_height: "Hoogte",
    env_weather: "Wind/Weer",
    env_noise: "Lawaai",
    env_dust: "Stof",
    env_thermal: "Warmte/Kou",
    env_chemical: "Chemicali√´n",

    ops_title: "Handelingen",
    ops_traffic: "Verkeer / voertuigen",
    ops_lift: "Hijswerk",
    ops_tools: "Handgereedschap",
    ops_atex: "ATEX",
    ops_confined: "Besloten ruimte",
    ops_others: "Andere",
    ops_others_ph: "Specifieer andere handelingen",

    measures_title: "Beheersmaatregelen",
    measures_seven: "7 lockoutregels + test",
    measures_ventilation: "Ventilatie / gasmeting",
    measures_earth: "Aarding",
    measures_balisage: "Afbakening / zonering",
    measures_watch: "Observator / spotter",
    measures_liftplan: "Hijsplan / SWL gecontroleerd",
    measures_anchor: "Ankerpunt / vallende voorwerpen",
    measures_toolsok: "Gereedschap conform / inspectie",
    measures_other: "Andere",
    measures_other_ph: "Specifieer andere maatregel",

    top3_title: "Top 3 risico‚Äôs & acties",
    risk_ph: "Risico",
    action_ph: "Onmiddellijke actie",
    resp_ph: "Verantwoordelijke",

    decision_title: "Beslissing & verantwoordelijke",
    go: "GO",
    no_go: "NO-GO",
    nogo_name: "Te verwittigen naam",
    nogo_name_ph: "Te verwittigen naam",
    nogo_tel: "Telefoon",
    nogo_tel_ph: "Telefoon",
    notes: "Opmerkingen",
    notes_ph: "Opmerkingen‚Ä¶",

    // First aid
    fa_title: "Eerste hulp",
    fa_info: "Informatie",
    person: "Betrokken persoon",
    action_title: "Handeling (op het moment)",
    a_cut: "Bij snijden",
    a_grind: "Bij slijpen",
    a_weld: "Bij lassen",
    a_drill: "Bij boren",
    a_pushpull: "Bij trekken/duwen",
    a_lift: "Bij heffen/neerzetten",
    other: "Andere",
    other_specify: "Specifieer‚Ä¶",
    injury_title: "Letsel",
    i_cut: "Snijwonde",
    i_scratch: "Schaafwonde",
    i_bruise: "Kneuzing (blauw/buil)",
    i_proj: "Projectie (stof/materiaal)",
    i_burn: "Brandwonde",
    location_title: "Plaats van het letsel",
    loc_hand: "Hand",
    loc_arm: "Arm",
    loc_torso: "Romp",
    loc_leg: "Been",
    loc_foot: "Voet",
    loc_head: "Hoofd",
    loc_eye: "Oog",
    kit_title: "EHBO-koffer",
    kit_need: "Moet de koffer aangevuld worden?",
    no: "Nee",
    yes: "Ja",
    kit_number: "Koffernummer",
    remarks: "Opmerkingen",

    // STOP
    stop_title: "STOP ‚Äì Onvoorzien",
    coords: "Gegevens",
    stop_box: "STOP",
    stop_desc: "Leg de situatie uit die tot STOP heeft geleid",
    call_box: "CALL",
    call_name: "Gecontacteerde verantwoordelijke ‚Äì Naam",
    call_role: "Functie",
    role_chef: "Ploegbaas",
    role_site: "Siteverantw.",
    role_pm: "PM",
    role_opm: "OPM",
    role_cp: "CP",
    role_coord: "Co√∂rdinator",
    role_client: "Klant",
    act_box: "ACT",
    solution: "Ingevoerde oplossing",
    nogo_wait: "NO-GO ‚Äî Situatie in afwachting van oplossing",
    },
  };
}
const I18N = window.QHSE_I18N; // alias unique    
   // Cl√©s i18n pour les listes
const MAP_KEYS = {
  energies: {
    electrique: 'energy_electric',
    mecanique:  'energy_mechanical',
    fluide:     'energy_fluid',
    gravite:    'energy_gravity',
  },
  env: {
    hauteur:  'env_height',
    meteo:    'env_weather',
    bruit:    'env_noise',
    poussiere:'env_dust',
    thermique:'env_thermal',
    chimique: 'env_chemical',
  },
  ops: {
    trafic:  'ops_traffic',
    levage:  'ops_lift',
    outillage:'ops_tools',
    atex:    'ops_atex',
    confine: 'ops_confined',
    autres:  'ops_others',
  },
  measures: {
    septRegles:'measures_seven',
    ventilation:'measures_ventilation',
    terre:'measures_earth',
    balisage:'measures_balisage',
    surveillant:'measures_watch',
    planLevage:'measures_liftplan',
    ancrage:'measures_anchor',
    outilsOk:'measures_toolsok',
    autre:'measures_other',
  }
};


    // ========================= HELPERS =========================
    const nowLocalDateTime = () => {
      const d=new Date(), pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const parseRoute = () => (location.hash.replace(/^#\/?/, '') || 'home');
    const saveLS = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
    const loadLS = (k,def)=>{ try{ const raw=localStorage.getItem(k); return raw? JSON.parse(raw): def; }catch{return def;} };

    // i18n hook & provider simples
    const I18nContext = React.createContext({ lang:'fr', t:(k)=>k, setLang:()=>{} });
    function I18nProvider({children}){
      const [lang, setLangState] = React.useState(loadLS(LANG_KEY, 'fr'));
      const setLang = (l)=>{ setLangState(l); saveLS(LANG_KEY,l); };
      const t = (key)=> (I18N[lang] && I18N[lang][key]) || (I18N.fr && I18N.fr[key]) || key;
      return <I18nContext.Provider value={{lang,t,setLang}}>{children}</I18nContext.Provider>;
    }
    const useI18n = ()=>React.useContext(I18nContext);

    // Petits composants g√©n√©riques
    function Section({ title, children }){ return <section className="card"><h2 className="text-lg font-semibold mb-2">{title}</h2>{children}</section>; }
    function Row({ children }){ return <div className="flex flex-col gap-3">{children}</div>; }
    function Toggle({ checked, onChange, label }){ return <label className="flex items-center justify-between gap-3 py-2"><span className="text-sm">{label}</span><input type="checkbox" className="w-5 h-5 accent-black" checked={checked} onChange={(e)=>onChange(e.target.checked)} /></label>; }
    function Divider(){ return <hr className="my-3 border-gray-200" />; }

    // Envoi + file d‚Äôattente locale (offline)
    async function sendNow(payload){
      try{
        await fetch(COLLECT_URL, { method:"POST", mode:"no-cors", headers:{ "Content-Type":"text/plain" }, body: JSON.stringify(payload) });
        return true;
      }catch(e){ console.warn(e); return false; }
    }
    function enqueueOutbox(item){
      const box = loadLS(OUTBOX_KEY, []);
      box.unshift(item);
      saveLS(OUTBOX_KEY, box.slice(0,500));
    }
    async function flushOutbox(){
      let box = loadLS(OUTBOX_KEY, []);
      if(!box.length) return {sent:0,left:0};
      let sent=0, left=[];
      for(const it of box){
        const ok = await sendNow(it);
        if(ok) sent++; else left.push(it);
      }
      saveLS(OUTBOX_KEY, left);
      return {sent,left:left.length};
    }
    window.addEventListener('online', ()=>{ flushOutbox(); });

    // Pr√©f√©rences (Responsable & √âquipe conserv√©s)
    const defaultPrefs = { responsable:"", team:[] };
  </script>
<!-- ===== FIN PARTIE 1/5 ===== -->
<!-- ===== HOTFIX: composant Tile global (√† mettre AVANT la PARTIE 2/5) ===== -->
<script type="text/babel">
  if (!window.QHSE_Tile) {
    window.QHSE_Tile = function Tile({href, icon, img, title, sub, muted}) {
      const base = "rounded-2xl p-4 text-center transition border";
      const active = "hover:bg-gray-50";
      const off = "border-dashed text-gray-300 pointer-events-none select-none";
      return (
        <a href={href||"#"} className={[base, muted?off:active].join(" ")}>
          {img ? (
            <img src={img} alt="" className={"w-10 h-10 mx-auto rounded " + (muted?"opacity-40":"")} />
          ) : (
            <div className={"text-3xl font-bold " + (muted?"opacity-40":"")}>{icon || "Ôºã"}</div>
          )}
          {title && <div className="font-semibold mt-2">{title}</div>}
          {sub && <div className="text-xs text-gray-500 mt-0.5">{sub}</div>}
        </a>
      );
    };
  }
</script>

<!-- ===== DEBUT PARTIE 2/5 : HOME (grille 2√ó2 cadr√©e, QR, how-to) ===== -->
<script type="text/babel" data-presets="env,react">
  function HomeScreen(){
    const { t } = useI18n();

    // Fallback : si le composant global n‚Äôexiste pas, on en cr√©e un local
    const TileC = window.QHSE_Tile || function Tile({href, icon, img, title, sub, muted}) {
      const base = "rounded-2xl p-4 text-center transition border";
      const active = "hover:bg-gray-50";
      const off = "border-dashed text-gray-300 pointer-events-none select-none";
      return (
        <a href={href||"#"} className={[base, muted?off:active].join(" ")}>
          {img ? (
            <img src={img} alt="" className={"w-10 h-10 mx-auto rounded " + (muted?"opacity-40":"")} />
          ) : (
            <div className={"text-3xl font-bold " + (muted?"opacity-40":"")}>{icon || "Ôºã"}</div>
          )}
          {title && <div className="font-semibold mt-2">{title}</div>}
          {sub && <div className="text-xs text-gray-500 mt-0.5">{sub}</div>}
        </a>
      );
    };

    const installUrl = (location.origin + location.pathname).replace(/#.*$/,'');

    return (
      <main className="max-w-md mx-auto p-4">
        <Section title={t('home_apps')}>
          {/* Grille 2√ó2 : LMRA (HG), Premiers soins (HD), STOP (BG), Emplacement vide (BD) */}
          <div className="grid grid-cols-2 gap-4">
            <TileC href="#lmra" icon="ü¶∫" title={t('tile_lmra_title')} sub={t('tile_lmra_sub')} />
            <TileC href="#firstaid" img="firstaid-icon.svg" title={t('tile_fa_title')} sub={t('tile_fa_sub')} />
            <TileC href="#stop" icon="üö¶" title={t('tile_stop_title')} sub={t('tile_stop_sub')} />
            <TileC muted img="" />
          </div>
        </Section>

        <Section title={t('home_install')}>
          <div className="flex flex-col items-center gap-3">
            <img
              src={"https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(installUrl)}
              alt="QR"
              className="w-44 h-44 rounded-lg border bg-white"
            />
            <div className="text-xs text-gray-500">{t('home_scan')}</div>
          </div>
        </Section>

        <Section title={t('install_howto_title')}>
          <pre className="whitespace-pre-wrap text-xs bg-gray-50 rounded-xl p-3 border">
            {t('install_howto_body')}
          </pre>
        </Section>
      </main>
    );
  }
</script>
<!-- ===== FIN PARTIE 2/5 ===== -->



<!-- ===== DEBUT PARTIE 3/5 : LMRA (Team/Permits/Energies/Env/Ops/Measures + Screen) ===== -->
<script type="text/babel" data-presets="env,react">
  // Hooks locaux
  function useLocalStorage(key, initial){
    const [val,setVal] = React.useState(()=>loadLS(key, initial));
    React.useEffect(()=>{ saveLS(key,val); },[key,val]);
    return [val,setVal];
  }

  function Team({data,setData}){
    const { t } = useI18n();
    const add = ()=>{
      const name = data.teamInput.trim(); if(!name) return;
      if(data.team.includes(name)) return setData({...data, teamInput:""});
      setData({...data, team:[...data.team, name], teamInput:""});
    };
    return (
      <div>
        <div className="flex gap-2 mb-2">
          <input value={data.teamInput} onChange={(e)=>setData({...data, teamInput:e.target.value})}
                 placeholder={t('team_member_ph')} className="flex-1 px-3 py-2 rounded-xl border" />
          <button onClick={add} className="px-3 py-2 rounded-xl border">{t('team_add')}</button>
        </div>
        <div className="flex flex-wrap gap-2">
          {data.team.map((n)=>(
            <span key={n} className="inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full bg-gray-100">
              {n}
              <button onClick={()=>setData({...data, team: data.team.filter(x=>x!==n)})}
                      className="w-5 h-5 inline-flex items-center justify-center rounded-full border">√ó</button>
            </span>
          ))}
          {!data.team.length && <span className="text-sm text-gray-400">{t('team_empty')}</span>}
        </div>
      </div>
    );
  }

  function Permits({data,setData}){
    const { t } = useI18n();
    return (
      <div>
        <div className="text-sm font-medium mb-2">{t('permits_title')}</div>
        <div className="grid grid-cols-2 gap-2">
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.feu} onChange={(e)=>setData({...data, permits:{...data.permits, feu:e.target.checked}})} />{t('permit_fire')}</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.electrique} onChange={(e)=>setData({...data, permits:{...data.permits, electrique:e.target.checked}})} />{t('permit_elec')}</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.confine} onChange={(e)=>setData({...data, permits:{...data.permits, confine:e.target.checked}})} />{t('permit_confined')}</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.levage} onChange={(e)=>setData({...data, permits:{...data.permits, levage:e.target.checked}})} />{t('permit_lift')}</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.autre} onChange={(e)=>setData({...data, permits:{...data.permits, autre:e.target.checked}})} />{t('permit_other')}</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.na} onChange={(e)=>setData({...data, permits:{...data.permits, na:e.target.checked}})} />{t('permit_na')}</label>
        </div>
        {data.permits.autre && (
          <input value={data.permits.autreText} onChange={(e)=>setData({...data, permits:{...data.permits, autreText:e.target.value}})}
                 placeholder={t('permit_other_ph')} className="mt-2 w-full px-3 py-2 rounded-xl border" />
        )}
      </div>
    );
  }

  function Energies({data,setData}){
    const { t } = useI18n();
    return (
      <div>
        <div className="text-sm font-medium mb-2">{t('energies_title')}</div>
        <div className="grid grid-cols-2 gap-2">
          {["electrique","mecanique","fluide","gravite"].map(k=>(
            <label key={k} className="flex items-center gap-2 text-sm">
              <input type="checkbox" className="w-4 h-4 accent-black"
                     checked={data.risks.energies[k]}
                     onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, [k]:e.target.checked}}})}/>
              {useI18n().t(MAP_KEYS.energies[k])}
            </label>
          ))}
          <label className="flex items-center gap-2 text-sm col-span-2">
            <input type="checkbox" className="w-4 h-4 accent-black"
                   checked={data.risks.energies.autre}
                   onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, autre:e.target.checked}}})}/>
            {t('other')}
          </label>
        </div>
        {data.risks.energies.autre && (
          <input value={data.risks.energies.autreText}
                 onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, autreText:e.target.value}}})}
                 placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border" />
        )}
      </div>
    );
  }

  function Environnement({data,setData}){
    const { t } = useI18n();
    return (
      <div>
        <div className="text-sm font-medium mb-2">{t('env_title')}</div>
        <div className="grid grid-cols-2 gap-2">
          {["hauteur","meteo","bruit","poussiere","thermique","chimique"].map(k=>(
            <label key={k} className="flex items-center gap-2 text-sm">
              <input type="checkbox" className="w-4 h-4 accent-black"
                     checked={data.risks.environnement[k]}
                     onChange={(e)=>setData({...data, risks:{...data.risks, environnement:{...data.risks.environnement, [k]:e.target.checked}}})}/>
              {useI18n().t(MAP_KEYS.env[k])}
            </label>
          ))}
        </div>
      </div>
    );
  }

  function Operations({data,setData}){
    const { t } = useI18n();
    return (
      <div>
        <div className="text-sm font-medium mb-2">{t('ops_title')}</div>
        <div className="grid grid-cols-2 gap-2">
          {["trafic","levage","outillage","atex","confine"].map(k=>(
            <label key={k} className="flex items-center gap-2 text-sm">
              <input type="checkbox" className="w-4 h-4 accent-black"
                     checked={data.risks.operations[k]}
                     onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, [k]:e.target.checked}}})}/>
              {useI18n().t(MAP_KEYS.ops[k])}
            </label>
          ))}
          <label className="flex items-center gap-2 text-sm col-span-2">
            <input type="checkbox" className="w-4 h-4 accent-black"
                   checked={data.risks.operations.autres}
                   onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, autres:e.target.checked}}})}/>
            {t('ops_others')}
          </label>
        </div>
        {data.risks.operations.autres && (
          <input value={data.risks.operations.autresText}
                 onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, autresText:e.target.value}}})}
                 placeholder={t('ops_others_ph')} className="mt-2 w-full px-3 py-2 rounded-xl border" />
        )}
      </div>
    );
  }

  function Measures({data,setData}){
    const { t } = useI18n(), K=MAP_KEYS.measures;
    return (
      <div className="grid grid-cols-2 gap-2">
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.septRegles} onChange={(e)=>setData({...data, measures:{...data.measures, septRegles:e.target.checked}})} />{t(K.septRegles)}</label>
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.ventilation} onChange={(e)=>setData({...data, measures:{...data.measures, ventilation:e.target.checked}})} />{t(K.ventilation)}</label>
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.terre} onChange={(e)=>setData({...data, measures:{...data.measures, terre:e.target.checked}})} />{t(K.terre)}</label>
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.balisage} onChange={(e)=>setData({...data, measures:{...data.measures, balisage:e.target.checked}})} />{t(K.balisage)}</label>
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.surveillant} onChange={(e)=>setData({...data, measures:{...data.measures, surveillant:e.target.checked}})} />{t(K.surveillant)}</label>
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.planLevage} onChange={(e)=>setData({...data, measures:{...data.measures, planLevage:e.target.checked}})} />{t(K.planLevage)}</label>
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.ancrage} onChange={(e)=>setData({...data, measures:{...data.measures, ancrage:e.target.checked}})} />{t(K.ancrage)}</label>
        <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.outilsOk} onChange={(e)=>setData({...data, measures:{...data.measures, outilsOk:e.target.checked}})} />{t(K.outilsOk)}</label>
        <label className="flex items-center gap-2 text-sm col-span-2"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.autre} onChange={(e)=>setData({...data, measures:{...data.measures, autre:e.target.checked}})} />{t(K.autre)}</label>
        {data.measures.autre && <input value={data.measures.autreText} onChange={(e)=>setData({...data, measures:{...data.measures, autreText:e.target.value}})} placeholder={useI18n().t('measures_other_ph')} className="mt-2 w-full px-3 py-2 rounded-xl border col-span-2" />}
      </div>
    );
  }

  function LmraScreen(){
    const { t } = useI18n();
    const [prefs,setPrefs] = useLocalStorage(PREFS_KEY, defaultPrefs);
    const initial = ()=>({
      version:"v3.2",
      datetime: nowLocalDateTime(),
      site:"", task:"", responsable: prefs.responsable || "", team: prefs.team || [], teamInput:"",
      conditions:{ tacheClaires:false, coactivite:false, zonage:false, epi:false },
      permits:{ feu:false, electrique:false, confine:false, levage:false, autre:false, autreText:"", na:false },
      risks:{
        energies:{ electrique:false, mecanique:false, fluide:false, gravite:false, autre:false, autreText:"" },
        environnement:{ hauteur:false, meteo:false, bruit:false, poussiere:false, thermique:false, chimique:false },
        operations:{ trafic:false, levage:false, outillage:false, atex:false, confine:false, autres:false, autresText:"" },
      },
      measures:{ septRegles:false, ventilation:false, terre:false, balisage:false, surveillant:false, planLevage:false, ancrage:false, outilsOk:false, autre:false, autreText:"" },
      top3:[{risk:"",action:"",resp:""},{risk:"",action:"",resp:""},{risk:"",action:"",resp:""}],
      decision:"GO",
      noGo:{ name:"", tel:"" },
      notes:""
    });

    const [data,setData] = React.useState(()=>loadLS(STORAGE_KEY, initial()));
    const [busy,setBusy] = React.useState(false);
    const [outboxLen,setOutboxLen] = React.useState(loadLS(OUTBOX_KEY, []).length);
    React.useEffect(()=>saveLS(STORAGE_KEY,data),[data]);

    const setField=(k,v)=>setData({...data,[k]:v});

    function currentPayload(){ return { meta:{ sentAt:new Date().toISOString(), page:location.href, userAgent:navigator.userAgent, formType:'lmra' }, data }; }

    async function envoyer(){
      const payload = currentPayload();
      setBusy(true);
      const ok = await sendNow(payload);
      setBusy(false);
      if(ok){
        alert(t('alert_sent'));
        // Conserver Responsable + √âquipe
        const keep = { responsable: data.responsable, team: data.team };
        setPrefs(keep);
        setData({ ...initial(), responsable: keep.responsable, team: keep.team });
      }else{
        enqueueOutbox(payload);
        setOutboxLen(loadLS(OUTBOX_KEY, []).length);
        alert(t('alert_offline_queued'));
      }
    }

    function resetAll(){
      setPrefs({ responsable:"", team:[] });
      setData(initial());
    }

    return (
      <main className="max-w-md mx-auto p-4">
        <Section title={t('lmra_title')}>
          <Row>
            <div className="flex items-center gap-2">
              <button onClick={resetAll} className="px-3 py-1.5 rounded-xl border">{t('reset_all')}</button>
              <span className="text-xs text-gray-500">{t('queue_label')}: {outboxLen}</span>
              <button onClick={()=>window.print()} className="ml-auto px-3 py-1.5 rounded-xl border">{t('print')}</button>
            </div>
            <div className="text-xs text-gray-500">{t('reset_hint_team')}</div>
          </Row>
        </Section>

        <Section title={t('general_info')}>
          <Row>
            <label className="text-sm">{t('datetime')}
              <input type="datetime-local" value={data.datetime} onChange={(e)=>setField("datetime", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('site')}
              <input value={data.site} onChange={(e)=>setField("site", e.target.value)} placeholder={t('site_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('task')}
              <input value={data.task} onChange={(e)=>setField("task", e.target.value)} placeholder={t('task_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('manager')}
              <input value={data.responsable} onChange={(e)=>setField("responsable", e.target.value)} placeholder={t('manager_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <div>
              <label className="text-sm block mb-2">{t('team')}</label>
              <Team data={data} setData={setData} />
            </div>
          </Row>
        </Section>

        <Section title={t('cond_title')}>
          <Row>
            <Toggle checked={data.conditions.tacheClaires} onChange={(v)=>setData({...data, conditions:{...data.conditions, tacheClaires:v}})} label={t('cond_task_clear')} />
            <Toggle checked={data.conditions.coactivite} onChange={(v)=>setData({...data, conditions:{...data.conditions, coactivite:v}})} label={t('cond_coactivity')} />
            <Toggle checked={data.conditions.zonage} onChange={(v)=>setData({...data, conditions:{...data.conditions, zonage:v}})} label={t('cond_zone')} />
            <Toggle checked={data.conditions.epi} onChange={(v)=>setData({...data, conditions:{...data.conditions, epi:v}})} label={t('cond_epi')} />
            <Divider />
            <Permits data={data} setData={setData} />
          </Row>
        </Section>

        <Section title={t('risks_title')}>
          <Row>
            <Energies data={data} setData={setData} />
            <Divider />
            <Environnement data={data} setData={setData} />
            <Divider />
            <Operations data={data} setData={setData} />
          </Row>
        </Section>

        <Section title={t('measures_title')}>
          <Row><Measures data={data} setData={setData} /></Row>
        </Section>

        <Section title={t('top3_title')}>
          <Row>
            {data.top3.map((t3,i)=>(
              <div key={i} className="grid grid-cols-1 gap-2">
                <div className="text-sm font-medium">#{i+1}</div>
                <input value={t3.risk} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], risk:e.target.value}; setField("top3", top3); }} placeholder={useI18n().t('risk_ph')} className="px-3 py-2 rounded-xl border" />
                <input value={t3.action} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], action:e.target.value}; setField("top3", top3); }} placeholder={useI18n().t('action_ph')} className="px-3 py-2 rounded-xl border" />
                <input value={t3.resp} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], resp:e.target.value}; setField("top3", top3); }} placeholder={useI18n().t('resp_ph')} className="px-3 py-2 rounded-xl border" />
                <Divider/>
              </div>
            ))}
          </Row>
        </Section>

        <Section title={t('decision_title')}>
          <Row>
            <div className="flex items-center gap-3">
              <button onClick={()=>setField("decision","GO")} className={"px-4 py-2 rounded-xl border "+(data.decision==="GO"?"bg-green-50 border-green-300":"")}>{t('go')}</button>
              <button onClick={()=>setField("decision","NO-GO")} className={"px-4 py-2 rounded-xl border "+(data.decision==="NO-GO"?"bg-red-50 border-red-300":"")}>{t('no_go')}</button>
            </div>
            {data.decision==="NO-GO" && (
              <div className="grid grid-cols-1 gap-2">
                <input value={data.noGo.name} onChange={(e)=>setField("noGo",{...data.noGo, name:e.target.value})} placeholder={t('nogo_name_ph')} className="px-3 py-2 rounded-xl border" />
                <input value={data.noGo.tel} onChange={(e)=>setField("noGo",{...data.noGo, tel:e.target.value})} placeholder={t('nogo_tel_ph')} className="px-3 py-2 rounded-xl border" />
              </div>
            )}
            <label className="text-sm">{t('notes')}
              <textarea value={data.notes} onChange={(e)=>setField("notes", e.target.value)} rows={2} placeholder={t('notes_ph')} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </Row>
        </Section>

        <Section title={t('send')}>
          <Row>
            <button onClick={envoyer} className="px-4 py-3 rounded-xl border bg-black text-white">{busy? t('sending') : t('send')}</button>
          </Row>
        </Section>
      </main>
    );
  }
</script>
<!-- ===== FIN PARTIE 3/5 ===== -->

  <!-- ===== DEBUT PARTIE 4/5 : FIRST AID + STOP ===== -->
<script type="text/babel" data-presets="env,react">
  // ===== FIRST AID =====
  function FirstAidScreen(){
    const { t } = useI18n();
    const initial = ()=>({
      datetime: nowLocalDateTime(), chantier:"", responsable:"", personne:"",
      actions:{ coupant:false, disquant:false, soudant:false, percant:false, tirant:false, soulevant:false, autre:false, autreText:"" },
      blessures:{ coupure:false, egratignure:false, contusion:false, projection:false, brulure:false, autre:false, autreText:"" },
      localisation:{ main:false, bras:false, torse:false, jambe:false, pied:false, tete:false, oeil:false, autre:false, autreText:"" },
      recharge:false, trousseNumero:"", remarques:""
    });
    const [fa,setFA] = React.useState(initial());
    const [busy,setBusy] = React.useState(false);

    function currentPayload(){ return { meta:{ sentAt:new Date().toISOString(), page:location.href, userAgent:navigator.userAgent, formType:'firstaid' }, data:fa }; }

    async function envoyer(){
      setBusy(true);
      const ok = await sendNow(currentPayload());
      setBusy(false);
      if(ok){ alert(t('alert_sent')); setFA(initial()); }
      else{ enqueueOutbox(currentPayload()); alert(t('alert_offline_queued')); }
    }

    const CB = ({checked,onChange,label})=>(
      <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={checked} onChange={(e)=>onChange(e.target.checked)} />{label}</label>
    );

    return (
      <main className="max-w-md mx-auto p-4">
        <Section title={t('fa_title')}>
          <Row>
            <button onClick={()=>setFA(initial())} className="px-3 py-1.5 rounded-xl border">{t('reset_all')}</button>
          </Row>
        </Section>

        <Section title={t('fa_info')}>
          <Row>
            <label className="text-sm">{t('datetime')}
              <input type="datetime-local" value={fa.datetime} onChange={(e)=>setFA({...fa, datetime:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('site')}
              <input value={fa.chantier} onChange={(e)=>setFA({...fa, chantier:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('manager')}
              <input value={fa.responsable} onChange={(e)=>setFA({...fa, responsable:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('person')}
              <input value={fa.personne} onChange={(e)=>setFA({...fa, personne:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </Row>
        </Section>

        <Section title={t('action_title')}>
          <div className="grid grid-cols-2 gap-2">
            <CB checked={fa.actions.coupant} onChange={(v)=>setFA({...fa, actions:{...fa.actions, coupant:v}})} label={t('a_cut')} />
            <CB checked={fa.actions.disquant} onChange={(v)=>setFA({...fa, actions:{...fa.actions, disquant:v}})} label={t('a_grind')} />
            <CB checked={fa.actions.soudant} onChange={(v)=>setFA({...fa, actions:{...fa.actions, soudant:v}})} label={t('a_weld')} />
            <CB checked={fa.actions.percant} onChange={(v)=>setFA({...fa, actions:{...fa.actions, percant:v}})} label={t('a_drill')} />
            <CB checked={fa.actions.tirant} onChange={(v)=>setFA({...fa, actions:{...fa.actions, tirant:v}})} label={t('a_pushpull')} />
            <CB checked={fa.actions.soulevant} onChange={(v)=>setFA({...fa, actions:{...fa.actions, soulevant:v}})} label={t('a_lift')} />
            <CB checked={fa.actions.autre} onChange={(v)=>setFA({...fa, actions:{...fa.actions, autre:v}})} label={t('other')} />
          </div>
          {fa.actions.autre && <input value={fa.actions.autreText} onChange={(e)=>setFA({...fa, actions:{...fa.actions, autreText:e.target.value}})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border" />}
        </Section>

        <Section title={t('injury_title')}>
          <div className="grid grid-cols-2 gap-2">
            <CB checked={fa.blessures.coupure} onChange={(v)=>setFA({...fa, blessures:{...fa.blessures, coupure:v}})} label={t('i_cut')} />
            <CB checked={fa.blessures.egratignure} onChange={(v)=>setFA({...fa, blessures:{...fa.blessures, egratignure:v}})} label={t('i_scratch')} />
            <CB checked={fa.blessures.contusion} onChange={(v)=>setFA({...fa, blessures:{...fa.blessures, contusion:v}})} label={t('i_bruise')} />
            <CB checked={fa.blessures.projection} onChange={(v)=>setFA({...fa, blessures:{...fa.blessures, projection:v}})} label={t('i_proj')} />
            <CB checked={fa.blessures.brulure} onChange={(v)=>setFA({...fa, blessures:{...fa.blessures, brulure:v}})} label={t('i_burn')} />
            <CB checked={fa.blessures.autre} onChange={(v)=>setFA({...fa, blessures:{...fa.blessures, autre:v}})} label={t('other')} />
          </div>
          {fa.blessures.autre && <input value={fa.blessures.autreText} onChange={(e)=>setFA({...fa, blessures:{...fa.blessures, autreText:e.target.value}})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border" />}
        </Section>

        <Section title={t('location_title')}>
          <div className="grid grid-cols-2 gap-2">
            {[
              ['main','loc_hand'],['bras','loc_arm'],['torse','loc_torso'],['jambe','loc_leg'],['pied','loc_foot'],['tete','loc_head'],['oeil','loc_eye']
            ].map(([k,label])=>(
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black"
                  checked={fa.localisation[k]}
                  onChange={(e)=>setFA({...fa, localisation:{...fa.localisation, [k]:e.target.checked}})} />
                {t(label)}
              </label>
            ))}
            <label className="flex items-center gap-2 text-sm col-span-2">
              <input type="checkbox" className="w-4 h-4 accent-black"
                checked={fa.localisation.autre}
                onChange={(e)=>setFA({...fa, localisation:{...fa.localisation, autre:e.target.checked}})} />
              {t('other')}
            </label>
          </div>
          {fa.localisation.autre && <input value={fa.localisation.autreText} onChange={(e)=>setFA({...fa, localisation:{...fa.localisation, autreText:e.target.value}})} placeholder={t('other_specify')} className="mt-2 w-full px-3 py-2 rounded-xl border" />}
        </Section>

        <Section title={t('kit_title')}>
          <Row>
            <div className="flex items-center gap-3">
              <span className="text-sm">{t('kit_need')}</span>
              <label className="text-sm flex items-center gap-2">
                <input type="radio" name="recharge" checked={!fa.recharge} onChange={()=>setFA({...fa, recharge:false})} />{t('no')}
              </label>
              <label className="text-sm flex items-center gap-2">
                <input type="radio" name="recharge" checked={fa.recharge} onChange={()=>setFA({...fa, recharge:true})} />{t('yes')}
              </label>
            </div>
            {fa.recharge && (
              <label className="text-sm">{t('kit_number')}
                <input value={fa.trousseNumero} onChange={(e)=>setFA({...fa, trousseNumero:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
            )}
            <label className="text-sm">{t('remarks')}
              <textarea value={fa.remarques} onChange={(e)=>setFA({...fa, remarques:e.target.value})} rows={2} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </Row>
        </Section>

        <Section title={t('send')}>
          <Row>
            <button onClick={envoyer} className="px-4 py-3 rounded-xl border bg-black text-white">{busy? t('sending') : t('send')}</button>
          </Row>
        </Section>
      </main>
    );
  }

  // ===== STOP =====
  function StopScreen(){
    const { t } = useI18n();
    const initial = ()=>({ datetime:nowLocalDateTime(), chantier:"", responsable:"", situation:"", callNom:"", callFonction:"chef", solution:"", noGo:false });
    const [st,setSt] = React.useState(initial());
    const [busy,setBusy] = React.useState(false);

    function currentPayload(){ return { meta:{ sentAt:new Date().toISOString(), page:location.href, userAgent:navigator.userAgent, formType:'stop' }, data:st }; }
    async function envoyer(){
      setBusy(true);
      const ok = await sendNow(currentPayload());
      setBusy(false);
      if(ok){ alert(t('alert_sent')); setSt(initial()); }
      else{ enqueueOutbox(currentPayload()); alert(t('alert_offline_queued')); }
    }

    const Box = ({title, color, children})=>(
      <div className={`rounded-2xl border-2 p-3 ${color==="red"?"border-red-500 bg-red-50":color==="orange"?"border-orange-500 bg-orange-50":"border-green-600 bg-green-50"}`}>
        <div className="font-semibold mb-2">{title}</div>
        {children}
      </div>
    );

    return (
      <main className="max-w-md mx-auto p-4">
        <Section title={t('stop_title')}>
          <Row><button onClick={()=>setSt(initial())} className="px-3 py-1.5 rounded-xl border">{t('reset_all')}</button></Row>
        </Section>

        <Section title={t('coords')}>
          <Row>
            <label className="text-sm">{t('datetime')}
              <input type="datetime-local" value={st.datetime} onChange={(e)=>setSt({...st, datetime:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('site')}
              <input value={st.chantier} onChange={(e)=>setSt({...st, chantier:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label className="text-sm">{t('manager')}
              <input value={st.responsable} onChange={(e)=>setSt({...st, responsable:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
          </Row>
        </Section>

        <Section title="STOP / CALL / ACT">
          <Row>
            <Box title={t('stop_box')} color="red">
              <label className="text-sm">{t('stop_desc')}
                <textarea value={st.situation} onChange={(e)=>setSt({...st, situation:e.target.value})} rows={2} className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
            </Box>

            <Box title={t('call_box')} color="orange">
              <div className="grid grid-cols-1 gap-2">
                <label className="text-sm">{t('call_name')}
                  <input value={st.callNom} onChange={(e)=>setSt({...st, callNom:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border" />
                </label>
                <label className="text-sm">{t('call_role')}
                  <select value={st.callFonction} onChange={(e)=>setSt({...st, callFonction:e.target.value})} className="mt-1 w-full px-3 py-2 rounded-xl border">
                    <option value="chef">{t('role_chef')}</option>
                    <option value="site">{t('role_site')}</option>
                    <option value="pm">{t('role_pm')}</option>
                    <option value="opm">{t('role_opm')}</option>
                    <option value="cp">{t('role_cp')}</option>
                    <option value="coord">{t('role_coord')}</option>
                    <option value="client">{t('role_client')}</option>
                  </select>
                </label>
              </div>
            </Box>

            <Box title={t('act_box')} color="green">
              <label className="text-sm">{t('solution')}
                <textarea value={st.solution} onChange={(e)=>setSt({...st, solution:e.target.value})} rows={2} className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="flex items-center gap-2 text-sm mt-2">
                <input type="checkbox" className="w-4 h-4 accent-black" checked={st.noGo} onChange={(e)=>setSt({...st, noGo:e.target.checked})} />
                {t('nogo_wait')}
              </label>
            </Box>
          </Row>
        </Section>

        <Section title={t('send')}>
          <Row>
            <button onClick={envoyer} className="px-4 py-3 rounded-xl border bg-black text-white">{busy? t('sending') : t('send')}</button>
          </Row>
        </Section>
      </main>
    );
  }
</script>
<!-- ===== FIN PARTIE 4/5 ===== -->

<!-- ===== DEBUT PARTIE 5/5 : APP SHELL + HEADER + RENDER (UX align√©e) ===== -->
<script type="text/babel" data-presets="env,react">
  // Logo seul (pas de texte redondant)
  function Brand(){
    return (
      <a href="#home" className="flex items-center gap-2" aria-label="QHSE">
        <img src="qhse-logo.svg" alt="" className="w-8 h-8 rounded-lg border"
             onError={(e)=>{ e.currentTarget.replaceWith(Object.assign(document.createElement('span'),{className:'inline-flex items-center justify-center w-8 h-8 rounded-lg border font-bold', innerText:'QHSE'})); }} />
      </a>
    );
  }

  // === LangPicker (images SVG locales) ===
  function LangPicker(){
    const { lang, setLang } = useI18n();
  
    const Btn = ({code, src, alt}) => (
      <button
        onClick={()=>setLang(code)}
        className={
          "w-9 h-9 flex items-center justify-center rounded-lg border " +
          (lang===code ? "bg-black" : "bg-white")
        }
        aria-label={code.toUpperCase()}
        title={code.toUpperCase()}
      >
        <img src={src} alt={alt} className="w-6 h-4 rounded-sm pointer-events-none select-none" />
      </button>
    );
  
    return (
      <div className="flex items-center gap-1.5">
        <Btn code="fr" src="flag-fr.svg" alt="FR" />
        <Btn code="en" src="flag-gb.svg" alt="EN" />
        <Btn code="nl" src="flag-nl.svg" alt="NL" />
      </div>
    );
  }


  function App(){
    const { t } = useI18n();
    const [route,setRoute] = React.useState(parseRoute());
    React.useEffect(()=>{
      const onHash=()=>setRoute(parseRoute());
      window.addEventListener('hashchange', onHash);
      return ()=>window.removeEventListener('hashchange', onHash);
    },[]);
    return (
      <div>
        <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
          <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-between gap-3">
            <Brand />
            <div className="flex items-center gap-3">
              <LangPicker />
              <button onClick={()=>window.print()} className="px-3 py-1.5 rounded-xl border">{t('print')}</button>
            </div>
          </div>
        </header>

        {route==='home' && <HomeScreen/>}
        {route==='lmra' && <LmraScreen/>}
        {route==='firstaid' && <FirstAidScreen/>}
        {route==='stop' && <StopScreen/>}

        <footer className="max-w-md mx-auto px-4 pb-8 text-center text-xs text-gray-400">
          QHSE PWA ‚Ä¢ Donn√©es locales + collecte centrale
        </footer>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<I18nProvider><App/></I18nProvider>);
</script>
<!-- ===== FIN PARTIE 5/5 ===== -->

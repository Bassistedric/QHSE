<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>TBM</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gray-50">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="index.html#home" class="flex items-center gap-2" aria-label="QHSE">
        <img src="qhse-logo.svg" alt="" class="w-8 h-8 rounded-lg border"
             onerror="this.replaceWith(Object.assign(document.createElement('span'),{className:'inline-flex items-center justify-center w-8 h-8 rounded-lg border font-bold',innerText:'QHSE'}))" />
      </a>
      <div class="flex items-center gap-1.5">
        <button onclick="setLang('fr')" class="w-9 h-9 flex items-center justify-center rounded-lg border bg-white" aria-label="FR" title="FR">
          <img src="flag-fr.svg" alt="FR" class="w-6 h-4 rounded-sm pointer-events-none select-none" />
        </button>
        <button onclick="setLang('en')" class="w-9 h-9 flex items-center justify-center rounded-lg border bg-white" aria-label="EN" title="EN">
          <img src="flag-gb.svg" alt="EN" class="w-6 h-4 rounded-sm pointer-events-none select-none" />
        </button>
        <button onclick="setLang('nl')" class="w-9 h-9 flex items-center justify-center rounded-lg border bg-white" aria-label="NL" title="NL">
          <img src="flag-nl.svg" alt="NL" class="w-6 h-4 rounded-sm pointer-events-none select-none" />
        </button>
      </div>
    </div>
  </header>

  <main class="space-y-4 max-w-md mx-auto px-4 py-4">
    <h1 class="text-2xl font-bold mb-4 px-4 py-2 rounded-xl bg-[#104861] text-[#D9D9D9] text-center">TBM</h1>

    <p id="loadStatus" class="text-sm text-gray-500"></p>
    <button id="retryBtn" class="text-sm text-blue-600 underline">Réessayer</button>

    <section class="bg-white rounded shadow p-4">
      <label for="dateInput" class="block text-sm font-medium mb-1">Date / heure</label>
      <input id="dateInput" type="datetime-local" class="border rounded px-2 py-1 w-full">
      <p id="weekHint" class="text-xs text-gray-500 mt-1"></p>
    </section>

    <section class="bg-white rounded shadow p-4">
      <label for="metier" class="block text-sm font-medium mb-1">Métier</label>
      <select id="metier" class="border rounded px-2 py-1 w-full">
        <option value="">Sélectionnez...</option>
        <option value="Elec">Elec</option>
        <option value="HVAC_REF">HVAC-Ref</option>
      </select>
    </section>

    <section class="bg-white rounded shadow p-4">
      <label for="chantierSelect" class="block text-sm font-medium mb-1">Chantier</label>
      <select id="chantierSelect" class="border rounded px-2 py-1 w-full"></select>
      <input id="chantierManual" type="text" class="border rounded px-2 py-1 w-full mt-1 text-sm" placeholder="Ajouter manuellement">
    </section>

    <section class="bg-white rounded shadow p-4">
      <label for="responsableSelect" class="block text-sm font-medium mb-1">Responsable (CE)</label>
      <select id="responsableSelect" class="border rounded px-2 py-1 w-full"></select>
      <input id="responsableManual" type="text" class="border rounded px-2 py-1 w-full mt-1 text-sm" placeholder="Ajouter manuellement">
      <p id="responsableHelper" class="text-sm text-gray-500 mt-1"></p>
    </section>

    <section class="bg-white rounded shadow p-4">
      <div class="flex items-center gap-4">
        <div id="thumbContainer" class="w-64 h-36 bg-gray-200 flex items-center justify-center text-sm text-gray-500">Vidéo non disponible</div>
        <div id="qrcode" class="w-32 h-32"></div>
      </div>
      <div class="mt-2 flex gap-2">
        <button id="playBtn" class="px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50">Lire la vidéo</button>
        <button id="copyLink" class="px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50">Copier le lien</button>
      </div>
    </section>

    <section class="bg-white rounded shadow p-4">
      <div class="flex justify-between items-center mb-2">
        <label class="text-sm font-medium">Équipe</label>
        <button id="toggleAll" class="text-sm text-blue-600 underline">Tout cocher</button>
      </div>
      <div id="teamContainer" class="flex flex-col gap-1 mb-2"></div>

      <div>
        <div class="flex gap-2">
          <input id="manualInput" type="text" class="border rounded px-2 py-1 flex-1" placeholder="Ajouter manuellement (séparés par des virgules)" list="manualSuggestions">
          <button id="manualAddBtn" type="button" class="px-3 py-1 bg-blue-600 text-white rounded">Valider</button>
        </div>
        <datalist id="manualSuggestions"></datalist>
        <div id="manualChips" class="flex flex-wrap gap-2 mt-2"></div>
        <p id="manualError" class="text-sm text-red-600 mt-1 hidden"></p>
      </div>
    </section>

    <section class="bg-white rounded shadow p-4">
      <button id="sendBtn" class="px-3 py-1 bg-black text-white rounded w-full">Envoyer</button>
      <p id="sendStatus" class="text-sm mt-1"></p>
    </section>

    <section class="bg-white rounded shadow p-4">
      <h2 class="text-lg font-medium mb-2">Historique</h2>
      <div class="flex gap-2 mb-2">
        <button id="exportBtn" class="px-3 py-1 bg-blue-600 text-white rounded">Exporter CSV</button>
        <button id="clearBtn" class="px-3 py-1 bg-red-600 text-white rounded">Vider l'historique</button>
      </div>
      <table id="historyTable" class="w-full text-sm"></table>
    </section>
  </main>

  <div id="confirmationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="confirmationTitle" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center space-y-4">
      <h2 id="confirmationTitle" class="text-lg font-semibold">Confirmation</h2>
      <p data-modal-message class="text-sm text-gray-700">Votre envoi a bien été pris en compte.</p>
      <button id="closeConfirmation" class="px-4 py-2 bg-blue-600 text-white rounded">OK</button>
    </div>
  </div>

  <script>
    const LANG_KEY = "qhse_lang_v1";
    function setLang(l){
      try{ localStorage.setItem(LANG_KEY, JSON.stringify(l)); }catch{}
      document.documentElement.lang = l;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { SHEET_BASE_URL, METIER_TO_GID, TBM_GID } from './sheetConfig.js';

    // URL Apps Script (collect TBM)
    const COLLECT_URL = "https://script.google.com/macros/s/AKfycbw53EiERifnozNg9ybNfbn_Ofm9NrFquashw_mbYoWyqtQROS6xXXzwVT2UQ4XxcJYK/exec";
    const OUTBOX_KEY = 'tbm_outbox_v1';

    const loadStatus = document.getElementById('loadStatus');
    const retryBtn = document.getElementById('retryBtn');
    const dateInput = document.getElementById('dateInput');
    const weekHint = document.getElementById('weekHint');

    const chantierSelect = document.getElementById('chantierSelect');
    const responsableSelect = document.getElementById('responsableSelect');
    const chantierManualInput = document.getElementById('chantierManual');
    const responsableManualInput = document.getElementById('responsableManual');
    const responsableHelper = document.getElementById('responsableHelper');

    const teamContainer = document.getElementById('teamContainer');
    const toggleAllBtn = document.getElementById('toggleAll');
    const manualInput = document.getElementById('manualInput');
    const manualChips = document.getElementById('manualChips');
    const manualAddBtn = document.getElementById('manualAddBtn');
    const manualSuggestions = document.getElementById('manualSuggestions');
    const manualError = document.getElementById('manualError');

    const thumbContainer = document.getElementById('thumbContainer');
    const qrcodeEl = document.getElementById('qrcode');
    const playBtn = document.getElementById('playBtn');
    const copyLinkBtn = document.getElementById('copyLink');

    const metierInput = document.getElementById('metier');
    const sendBtn = document.getElementById('sendBtn');
    const sendStatus = document.getElementById('sendStatus');

    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const historyTable = document.getElementById('historyTable');

    const confirmationModal = document.getElementById('confirmationModal');
    const closeConfirmationBtn = document.getElementById('closeConfirmation');
    const confirmationMessage = confirmationModal.querySelector('[data-modal-message]');

    // AFFECTATIONS_SEMAINE rows (objects)
    let affectRows = [];
    // TBM video sheet raw
    let tbmData = null;

    let manualMembers = [];
    const normalizedNameMap = new Map();
    let lastVideoUrl = '';

    function enqueue(item){
      const queue = JSON.parse(localStorage.getItem(OUTBOX_KEY) || '[]');
      queue.push(item);
      localStorage.setItem(OUTBOX_KEY, JSON.stringify(queue));
    }

    async function flushQueue(){
      const queue = JSON.parse(localStorage.getItem(OUTBOX_KEY) || '[]');
      const remaining = [];
      for(const item of queue){
        try{
          await fetch(COLLECT_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(item)});
        }catch(e){
          remaining.push(item);
        }
      }
      localStorage.setItem(OUTBOX_KEY, JSON.stringify(remaining));
    }

    window.addEventListener('online', flushQueue);

    function normalize(str){
      return String(str ?? '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .trim();
    }

    function normUpper(str){
      return normalize(str).toUpperCase().replace(/\s+/g,' ');
    }

    function csvUrl(base, gid){
      if (typeof gid !== 'string' || gid.trim() === '') return null;
      try {
        const u = new URL(base);
        u.searchParams.set('output','csv');
        u.searchParams.set('gid', gid);
        return u.toString();
      } catch {
        return null;
      }
    }

    function parseCsv(url){
      return new Promise((resolve,reject)=>{
        Papa.parse(url,{
          download:true,
          complete: res => resolve(res.data),
          error: err => reject(err)
        });
      });
    }

    function sheetToMetier(sheetName) {
      const s = String(sheetName || "").trim().toLowerCase();
      if (s === "equipe_elec") return "Elec";
      if (s === "equipe_hvac_ref") return "HVAC_REF";
      return "";
    }

    // ISO week (EU) from Date
    function isoWeek(dateObj){
      const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getSelectedWeek(){
      const d = new Date(dateInput.value);
      if (!(d instanceof Date) || isNaN(d.getTime())) return null;
      return isoWeek(d);
    }

    function updateWeekHint(){
      const w = getSelectedWeek();
      weekHint.textContent = w ? `Semaine ISO détectée : ${w}` : '';
    }

    function uniqSorted(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b,'fr'));
    }

    function clearSelect(sel){
      sel.innerHTML = '';
    }

    function setSelectOptions(sel, values){
      clearSelect(sel);
      values.forEach((v,i)=>{
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    function getFilteredRowsBase(){
      const metier = metierInput.value;
      const week = getSelectedWeek();
      if (!metier || !week) return [];
      return affectRows.filter(r => r.metier === metier && r.semaine === week);
    }

    function updateKnownNamesFromRows(rows){
      normalizedNameMap.clear();
      manualSuggestions.innerHTML = '';
      const names = uniqSorted(rows.map(r=>r.ouvrier));
      names.forEach(name=>{
        const opt=document.createElement('option');
        opt.value=name;
        manualSuggestions.appendChild(opt);

        const key = normUpper(name);
        if(!normalizedNameMap.has(key)) normalizedNameMap.set(key, []);
        normalizedNameMap.get(key).push(name);
      });
    }

    function populateChantiers(){
      // manual chantier override
      if(chantierManualInput.value.trim()){
        clearSelect(chantierSelect);
        clearSelect(responsableSelect);
        teamContainer.innerHTML='';
        chantierSelect.disabled=true;
        responsableSelect.disabled=true;
        return;
      }

      const base = getFilteredRowsBase();
      if(!base.length){
        loadStatus.textContent = 'Sélectionnez un métier + une date (semaine)';
        chantierSelect.disabled=true;
        responsableSelect.disabled=true;
        teamContainer.innerHTML='';
        return;
      }

      chantierSelect.disabled=false;
      responsableSelect.disabled=true;
      responsableHelper.textContent='';
      teamContainer.innerHTML='';

      const chantiers = uniqSorted(base
        .map(r=>r.chantier)
        .filter(ch => {
          const n = normUpper(ch);
          return n !== 'CONGE' && n !== 'MALADE';
        })
      );

      setSelectOptions(chantierSelect, chantiers);

      if(chantiers.length){
        chantierSelect.value = chantiers[0];
        populateResponsableAndTeam();
      }
    }

    function populateResponsableAndTeam(){
      if(chantierManualInput.value.trim()){
        clearSelect(responsableSelect);
        teamContainer.innerHTML='';
        responsableSelect.disabled=true;
        return;
      }

      teamContainer.innerHTML='';
      clearSelect(responsableSelect);
      responsableHelper.textContent='';

      const chantier = chantierSelect.value;
      if(!chantier) return;

      const base = getFilteredRowsBase();
      const target = normUpper(chantier);

      const chantierRows = base.filter(r => normUpper(r.chantier) === target);

      const ces = uniqSorted(chantierRows.map(r=>r.ce));
      if(ces.length){
        setSelectOptions(responsableSelect, ces);
        responsableSelect.disabled=false;
      }else{
        responsableSelect.disabled=true;
        responsableHelper.textContent='Aucun CE trouvé';
      }

      if(responsableManualInput.value.trim()){
        responsableSelect.disabled=true;
      }

      // default selected CE to first
      const selectedCE = responsableManualInput.value.trim() || (responsableSelect.disabled ? '' : responsableSelect.value);
      if(!selectedCE){
        // still render all ouvriers for chantier even without CE selection? -> no, keep consistent
        return;
      }

      const ceTarget = normUpper(selectedCE);
      const members = uniqSorted(chantierRows
        .filter(r => normUpper(r.ce) === ceTarget)
        .map(r=>r.ouvrier)
      );

      members.forEach(n=>{
        const lbl=document.createElement('label');
        lbl.className='inline-flex items-center gap-2';
        const cb=document.createElement('input');
        cb.type='checkbox'; cb.value=n; cb.className='rounded';
        lbl.appendChild(cb); lbl.append(n);
        teamContainer.appendChild(lbl);
      });
    }

    function populateVideo(){
      thumbContainer.innerHTML='Vidéo non disponible';
      qrcodeEl.innerHTML='';
      playBtn.disabled=true;
      copyLinkBtn.disabled=true;
      lastVideoUrl='';
      if(!tbmData) return;

      const monthName = new Date(dateInput.value).toLocaleString('fr-FR',{month:'long'}).toLowerCase();
      for(const row of tbmData){
        if((row[0]||'').toString().toLowerCase() === monthName){
          const url = row[1];
          if(url){
            lastVideoUrl = url;
            renderVideo(url);
          }
          break;
        }
      }
    }

    function renderVideo(url){
      const id = extractYoutubeId(url);
      const img = new Image();
      img.alt='Miniature';
      img.className='w-64 h-36 object-cover rounded';
      img.src=`https://img.youtube.com/vi/${id}/maxresdefault.jpg`;
      img.onerror=()=>{img.src=`https://img.youtube.com/vi/${id}/hqdefault.jpg`;};
      thumbContainer.innerHTML='';
      thumbContainer.appendChild(img);
      playBtn.disabled=false;
      copyLinkBtn.disabled=false;
      qrcodeEl.innerHTML='';
      new QRCode(qrcodeEl,{text:url,width:128,height:128});
    }

    function extractYoutubeId(url){
      const m = String(url||'').match(/(?:v=|\.be\/)([\w-]{11})/);
      return m?m[1]:'';
    }

    function updateAll(){
      updateWeekHint();
      const base = getFilteredRowsBase();
      updateKnownNamesFromRows(base);
      populateChantiers();
      populateVideo();
    }

    async function loadSheets(){
      loadStatus.textContent = 'Chargement...';

      try{
        // 1) Affectations (AFFECTATIONS_SEMAINE) : on charge UNE feuille selon metier->gid
        // (les 2 métiers pointent sur le même gid, mais on garde la logique)
        const metier = metierInput.value || 'Elec';
        const gid = METIER_TO_GID[metier] || METIER_TO_GID.Elec;
        const url = csvUrl(SHEET_BASE_URL, gid);
        if(!url) throw new Error('GID invalide pour les affectations.');

        const raw = await parseCsv(url);
        const headers = (raw[0] || []).map(h => String(h||'').trim());

        // mapping attendu
        const idx = {
          annee: headers.indexOf('Annee'),
          semaine: headers.indexOf('Semaine'),
          pm: headers.indexOf('PM'),
          sisu: headers.indexOf('SiSU'),
          ce: headers.indexOf('CE'),
          ouvrier: headers.indexOf('Ouvrier'),
          chantier: headers.indexOf('Chantier'),
          sheet: headers.indexOf('Sheet')
        };

        if(idx.semaine < 0 || idx.ouvrier < 0 || idx.chantier < 0 || idx.ce < 0 || idx.sheet < 0){
          console.error('Headers affectations:', headers);
          throw new Error("En-têtes AFFECTATIONS_SEMAINE inattendus.");
        }

        affectRows = raw.slice(1)
          .filter(r => r && r.length)
          .map(r => {
            const sheet = (r[idx.sheet] || '').toString().trim();
            return {
              annee: parseInt(r[idx.annee],10) || null,
              semaine: parseInt(r[idx.semaine],10) || null,
              pm: (r[idx.pm] || '').toString().trim(),
              sisu: (r[idx.sisu] || '').toString().trim(),
              ce: (r[idx.ce] || '').toString().trim(),
              ouvrier: (r[idx.ouvrier] || '').toString().trim(),
              chantier: (r[idx.chantier] || '').toString().trim(),
              sheet,
              metier: sheetToMetier(sheet) || '' // <-- clé !
            };
          })
          .filter(r => r.semaine && r.ouvrier && r.chantier && r.metier);

        // 2) TBM videos
        const tbmUrl = csvUrl(SHEET_BASE_URL, TBM_GID);
        if(tbmUrl){
          try{
            tbmData = await parseCsv(tbmUrl);
          }catch(e){
            console.error('Failed to load TBM sheet', e);
            tbmData = null;
          }
        }

        loadStatus.textContent = 'Feuilles chargées';
        updateAll();

      }catch(e){
        loadStatus.textContent = 'Impossible de charger les données';
        console.error(e);
      }
    }

    // ---- manual chips helpers
    function setManualError(message){
      if(message){
        manualError.textContent = message;
        manualError.classList.remove('hidden');
      }else{
        manualError.textContent = '';
        manualError.classList.add('hidden');
      }
    }

    function resolveName(input){
      const key = normUpper(input);
      const matches = normalizedNameMap.get(key);
      if(!matches || !matches.length) return null;
      const exact = matches.find(n=>n===input);
      return exact || matches[0];
    }

    function createManualChip(name){
      const chip=document.createElement('span');
      chip.className='bg-blue-100 px-2 py-1 rounded-full flex items-center gap-1';
      chip.textContent=name;
      const x=document.createElement('button');
      x.textContent='×';
      x.className='text-red-600';
      x.addEventListener('click',()=>{
        manualMembers=manualMembers.filter(m=>m!==name);
        chip.remove();
      });
      chip.appendChild(x);
      manualChips.appendChild(chip);
    }

    function addManual(){
      const raw = manualInput.value;
      if(!raw.trim()){
        setManualError('');
        return false;
      }
      const names = raw.split(',').map(n=>n.trim()).filter(n=>n);
      if(!names.length){
        setManualError('');
        manualInput.value='';
        return false;
      }
      const invalid = [];
      let hasValid=false;
      names.forEach(n=>{
        const resolved = resolveName(n);
        if(!resolved){
          invalid.push(n);
          return;
        }
        hasValid=true;
        if(!manualMembers.includes(resolved)){
          manualMembers.push(resolved);
          createManualChip(resolved);
        }
      });
      if(invalid.length){
        manualInput.value = invalid.join(', ');
        setManualError('Ce nom ne correspond pas à la liste proposée.');
        return false;
      }else{
        manualInput.value='';
        if(hasValid) setManualError('');
        return hasValid;
      }
    }

    // ---- UI hooks
    retryBtn.addEventListener('click', loadSheets);

    toggleAllBtn.addEventListener('click',()=>{
      const boxes = teamContainer.querySelectorAll('input[type="checkbox"]');
      const allChecked = Array.from(boxes).every(b=>b.checked);
      boxes.forEach(b=>b.checked=!allChecked);
    });

    metierInput.addEventListener('change', ()=>{
      // quand on change métier, on recharge (car affectRows dépend de sheetToMetier)
      loadSheets();
    });

    chantierSelect.addEventListener('change', populateResponsableAndTeam);

    chantierManualInput.addEventListener('input',()=>{
      if(chantierManualInput.value.trim()){
        chantierSelect.disabled=true;
        chantierSelect.value='';
        clearSelect(responsableSelect);
        responsableSelect.disabled=true;
        responsableHelper.textContent='';
        teamContainer.innerHTML='';
      }else{
        chantierSelect.disabled=false;
        populateChantiers();
      }
    });

    responsableManualInput.addEventListener('input',()=>{
      if(responsableManualInput.value.trim()){
        responsableSelect.disabled=true;
        responsableSelect.value='';
        responsableHelper.textContent='';
        populateResponsableAndTeam();
      }else{
        populateResponsableAndTeam();
      }
    });

    dateInput.addEventListener('change', ()=>{
      updateAll();
    });

    manualInput.addEventListener('keydown',e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        addManual();
        manualInput.focus();
      }
    });
    manualInput.addEventListener('blur',addManual);
    manualInput.addEventListener('input',()=> setManualError(''));
    manualAddBtn.addEventListener('click',()=>{
      addManual();
      manualInput.focus();
    });

    playBtn.addEventListener('click',()=>{
      if(!lastVideoUrl) return;
      window.open(lastVideoUrl, '_blank');
    });

    copyLinkBtn.addEventListener('click',async()=>{
      if(!lastVideoUrl) return;
      try{await navigator.clipboard.writeText(lastVideoUrl);}catch(e){}
    });

    function showConfirmation(message){
      confirmationMessage.textContent = message;
      confirmationModal.classList.remove('hidden');
      confirmationModal.setAttribute('aria-hidden','false');
      closeConfirmationBtn.focus();
    }
    function hideConfirmation(){
      confirmationModal.classList.add('hidden');
      confirmationModal.setAttribute('aria-hidden','true');
      sendBtn.focus();
    }

    closeConfirmationBtn.addEventListener('click', hideConfirmation);
    confirmationModal.addEventListener('click', event => {
      if(event.target === confirmationModal) hideConfirmation();
    });
    document.addEventListener('keydown', event => {
      if(event.key === 'Escape' && !confirmationModal.classList.contains('hidden')) hideConfirmation();
    });

    sendBtn.addEventListener('click',async()=>{
      const dateVal=dateInput.value;
      const metier=metierInput.value.trim();
      const chantier=chantierManualInput.value.trim()||chantierSelect.value;
      const responsable=responsableManualInput.value.trim()||(responsableSelect.disabled?'':responsableSelect.value);
      const members=[...teamContainer.querySelectorAll('input[type="checkbox"]:checked')].map(b=>b.value).concat(manualMembers);

      if(!dateVal||!metier||!chantier||!responsable||!members.length||!lastVideoUrl){
        sendStatus.textContent='Veuillez remplir tous les champs.';
        return;
      }

      sendBtn.disabled = true;
      const originalLabel = sendBtn.textContent;
      sendBtn.textContent = 'Envoi...';

      const payload={
        type:'tbm',
        meta:{userAgent:navigator.userAgent},
        data:{datetime:dateVal,metier,chantier,responsable,equipe:members,youtubeUrl:lastVideoUrl}
      };

      try{
        await fetch(COLLECT_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
        sendStatus.textContent='Envoyé';
        showConfirmation('Votre envoi a bien été pris en compte.');
        teamContainer.querySelectorAll('input[type="checkbox"]').forEach(b=>b.checked=false);
        manualMembers=[];manualChips.innerHTML='';
        setManualError('');
      }catch(e){
        sendStatus.textContent="Erreur d'envoi, enregistré localement.";
        enqueue(payload);
        showConfirmation("Une erreur réseau est survenue. L'envoi sera retenté automatiquement.");
      }

      const entries=JSON.parse(localStorage.getItem('tbmEntries')||'[]');
      entries.push({
        savedAt:new Date().toISOString(),
        dateHeure:dateVal,
        metier,chantier,responsable,equipe:members,youtubeUrl:lastVideoUrl
      });
      localStorage.setItem('tbmEntries',JSON.stringify(entries));
      loadHistory();

      sendBtn.disabled = false;
      sendBtn.textContent = originalLabel;
    });

    function loadHistory(){
      const entries=JSON.parse(localStorage.getItem('tbmEntries')||'[]');
      historyTable.innerHTML='';
      entries.forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class='border px-1'>${e.dateHeure}</td><td class='border px-1'>${e.metier}</td><td class='border px-1'>${e.chantier}</td><td class='border px-1'>${e.responsable}</td><td class='border px-1'>${e.equipe.join(', ')}</td>`;
        historyTable.appendChild(tr);
      });
    }

    exportBtn.addEventListener('click',()=>{
      const entries=JSON.parse(localStorage.getItem('tbmEntries')||'[]');
      if(!entries.length) return;
      const header=['savedAt','dateHeure','metier','chantier','responsable','equipe','youtubeUrl'];
      const rows=entries.map(e=>header.map(h=>Array.isArray(e[h])?e[h].join('|'):e[h]));
      let csv=header.join(',')+'\n';
      rows.forEach(r=>{csv+=r.join(',')+'\n';});
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='tbm.csv';
      a.click();
    });

    clearBtn.addEventListener('click',()=>{
      localStorage.removeItem('tbmEntries');
      loadHistory();
    });

    function init(){
      const now=new Date();
      now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
      dateInput.value=now.toISOString().slice(0,16);
      updateWeekHint();
      flushQueue();
      loadHistory();
      loadSheets();
    }
    init();
  </script>
</body>
</html>

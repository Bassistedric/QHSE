<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>TBM</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="index.html#home" class="flex items-center gap-2" aria-label="QHSE">
        <img src="qhse-logo.svg" alt="" class="w-8 h-8 rounded-lg border"
             onerror="this.replaceWith(Object.assign(document.createElement('span'),{className:'inline-flex items-center justify-center w-8 h-8 rounded-lg border font-bold',innerText:'QHSE'}))" />
      </a>
      <div class="flex items-center gap-1.5">
        <button onclick="setLang('fr')" class="w-9 h-9 flex items-center justify-center rounded-lg border bg-white" aria-label="FR" title="FR">
          <img src="flag-fr.svg" alt="FR" class="w-6 h-4 rounded-sm pointer-events-none select-none" />
        </button>
        <button onclick="setLang('en')" class="w-9 h-9 flex items-center justify-center rounded-lg border bg-white" aria-label="EN" title="EN">
          <img src="flag-gb.svg" alt="EN" class="w-6 h-4 rounded-sm pointer-events-none select-none" />
        </button>
        <button onclick="setLang('nl')" class="w-9 h-9 flex items-center justify-center rounded-lg border bg-white" aria-label="NL" title="NL">
          <img src="flag-nl.svg" alt="NL" class="w-6 h-4 rounded-sm pointer-events-none select-none" />
        </button>
      </div>
    </div>
  </header>
    <main class="space-y-4 max-w-md mx-auto px-4 py-4">
      <h1 class="text-2xl font-bold mb-4 px-4 py-2 rounded-xl bg-[#104861] text-[#D9D9D9] text-center">TBM</h1>
      <p id="loadStatus" class="text-sm text-gray-500"></p>
      <button id="retryBtn" class="text-sm text-blue-600 underline">Réessayer</button>

      <section class="bg-white rounded shadow p-4">
      <label for="dateInput" class="block text-sm font-medium mb-1">Date / heure</label>
      <input id="dateInput" type="datetime-local" class="border rounded px-2 py-1 w-full">
    </section>

    <section class="bg-white rounded shadow p-4">
      <label for="metier" class="block text-sm font-medium mb-1">Métier</label>
      <select id="metier" class="border rounded px-2 py-1 w-full">
        <option value="">Sélectionnez...</option>
        <option value="Elec">Elec</option>
        <option value="HVAC_REF">HVAC-Ref</option>
      </select>
    </section>

    <section class="bg-white rounded shadow p-4">
      <label for="chantierSelect" class="block text-sm font-medium mb-1">Chantier</label>
      <select id="chantierSelect" class="border rounded px-2 py-1 w-full"></select>
    </section>

    <section class="bg-white rounded shadow p-4">
      <label for="responsableSelect" class="block text-sm font-medium mb-1">Responsable (CE)</label>
      <select id="responsableSelect" class="border rounded px-2 py-1 w-full"></select>
      <p id="responsableHelper" class="text-sm text-gray-500 mt-1"></p>
    </section>

    <section class="bg-white rounded shadow p-4">
      <div class="flex justify-between items-center mb-2">
        <label class="text-sm font-medium">Équipe</label>
        <button id="toggleAll" class="text-sm text-blue-600 underline">Tout cocher</button>
      </div>
      <div id="teamContainer" class="flex flex-col gap-1 mb-2"></div>
      <div>
        <input id="manualInput" type="text" class="border rounded px-2 py-1 w-full" placeholder="Ajouter manuellement (séparés par des virgules)">
        <div id="manualChips" class="flex flex-wrap gap-2 mt-2"></div>
      </div>
    </section>

    <section class="bg-white rounded shadow p-4">
      <div class="flex items-center gap-4">
        <div id="thumbContainer" class="w-64 h-36 bg-gray-200 flex items-center justify-center text-sm text-gray-500">Vidéo non disponible</div>
        <div id="qrcode" class="w-32 h-32"></div>
      </div>
      <div class="mt-2 flex gap-2">
        <button id="playBtn" class="px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50">Lire la vidéo</button>
        <button id="copyLink" class="px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50">Copier le lien</button>
      </div>
      <dialog id="videoDialog" class="p-0">
        <iframe id="videoFrame" width="560" height="315" allow="autoplay" allowfullscreen></iframe>
      </dialog>
    </section>

    <section class="bg-white rounded shadow p-4">
      <button id="sendBtn" class="px-3 py-1 bg-green-600 text-white rounded w-full">Envoyer</button>
      <p id="sendStatus" class="text-sm mt-1"></p>
    </section>

    <section class="bg-white rounded shadow p-4">
      <h2 class="text-lg font-medium mb-2">Historique</h2>
      <div class="flex gap-2 mb-2">
        <button id="exportBtn" class="px-3 py-1 bg-blue-600 text-white rounded">Exporter CSV</button>
        <button id="clearBtn" class="px-3 py-1 bg-red-600 text-white rounded">Vider l'historique</button>
      </div>
      <table id="historyTable" class="w-full text-sm"></table>
    </section>
  </main>

  <script>
    const LANG_KEY = "qhse_lang_v1";
    function setLang(l){
      try{ localStorage.setItem(LANG_KEY, JSON.stringify(l)); }catch{}
      document.documentElement.lang = l;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="module">
      import { SHEET_BASE_URL, METIER_TO_GID, TBM_GID } from './sheetConfig.js';
      const loadStatus = document.getElementById('loadStatus');
      const retryBtn = document.getElementById('retryBtn');
      const dateInput = document.getElementById('dateInput');
    const chantierSelect = document.getElementById('chantierSelect');
    const responsableSelect = document.getElementById('responsableSelect');
    const responsableHelper = document.getElementById('responsableHelper');
    const teamContainer = document.getElementById('teamContainer');
    const toggleAllBtn = document.getElementById('toggleAll');
    const manualInput = document.getElementById('manualInput');
    const manualChips = document.getElementById('manualChips');
    const thumbContainer = document.getElementById('thumbContainer');
    const qrcodeEl = document.getElementById('qrcode');
    const playBtn = document.getElementById('playBtn');
    const copyLinkBtn = document.getElementById('copyLink');
    const videoDialog = document.getElementById('videoDialog');
    const videoFrame = document.getElementById('videoFrame');
    const metierInput = document.getElementById('metier');
    const sendBtn = document.getElementById('sendBtn');
    const sendStatus = document.getElementById('sendStatus');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const historyTable = document.getElementById('historyTable');

    let equipeData = null;
    let equipeSheets = {};
    let tbmData = null;
    let manualMembers = [];
    let lastVideoUrl = '';

    function normalize(str){
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }

    function csvUrl(base, gid){
      try{
        const u = new URL(base);
        u.searchParams.set('output','csv');
        u.searchParams.set('gid',gid);
        return u.toString();
      }catch(e){
        return base;
      }
    }

    function parseCsv(url){
      return new Promise((resolve,reject)=>{
        Papa.parse(url,{
          download:true,
          complete: res => resolve(res.data),
          error: err => reject(err)
        });
      });
    }

    async function loadSheets(){
      loadStatus.textContent = 'Chargement...';
      try{
        const base = SHEET_BASE_URL;
        const sheetPromises = Object.entries(METIER_TO_GID).map(([metier, gid]) =>
          parseCsv(csvUrl(base, gid)).then(data => {
            equipeSheets[metier] = data;
          })
        );
        const tbmPromise = parseCsv(csvUrl(base, TBM_GID)).then(data => { tbmData = data; });
        await Promise.all([...sheetPromises, tbmPromise]);
        equipeData = equipeSheets[metierInput.value] || null;
        loadStatus.textContent = 'Feuilles chargées';
        updateAll();
      }catch(e){
        loadStatus.textContent = 'Impossible de charger les données';
        console.error(e);
      }
    }

    function updateAll(){
      populateChantiers();
      populateVideo();
    }

    function findColumnIndex(data, date){
      if(!data || !data.length){
        loadStatus.textContent = 'Données de feuille indisponibles';
        return -1;
      }

      const monthName = normalize(date.toLocaleString('fr-FR',{month:'long'})).toLowerCase();
      const m = date.getMonth()+1;
      const monthNum = String(m);
      const monthNumPadded = monthNum.padStart(2,'0');
      const year = String(date.getFullYear());
      const monthVariants = [
        monthName,
        monthNum,
        monthNumPadded,
        `${monthNum}/${year}`,
        `${monthNumPadded}/${year}`
      ];
      const day = String(date.getDate());
      const dayPadded = day.padStart(2,'0');
      const dayVariants = [day, dayPadded];

      function tryRows(monthRowIndex, dayRowIndex){
        const monthsRow = (data[monthRowIndex] || []).map(c => normalize((c||'').toString()).toLowerCase());
        const daysRow = (data[dayRowIndex] || []).map(c => normalize((c||'').toString()).toLowerCase());
        const len = Math.max(monthsRow.length, daysRow.length);
        for(let i=0;i<len;i++){
          if(monthVariants.includes(monthsRow[i]) && dayVariants.includes(daysRow[i])){
            return i;
          }
        }
        return -1;
      }

      // Try rows 4-5 first (1-based indices)
      let col = tryRows(3,4);
      if(col !== -1) return col;

      // Fallback to rows 1-2
      col = tryRows(0,1);
      if(col !== -1) return col;

      // Auto-detect rows containing months and days
      let monthRowIdx=-1, dayRowIdx=-1;
      for(let r=0;r<Math.min(10,data.length);r++){
        const row = (data[r] || []).map(c => normalize((c||'').toString()).toLowerCase());
        if(monthRowIdx===-1 && row.some(c=>monthVariants.includes(c))) monthRowIdx=r;
        if(dayRowIdx===-1 && row.some(c=>dayVariants.includes(c))) dayRowIdx=r;
        if(monthRowIdx!==-1 && dayRowIdx!==-1) break;
      }
      if(monthRowIdx!==-1 && dayRowIdx!==-1){
        col = tryRows(monthRowIdx, dayRowIdx);
        if(col !== -1) return col;
      }

      loadStatus.textContent = 'Impossible de trouver une colonne pour cette date';
      return -1;
    }

    function populateChantiers(){
      chantierSelect.innerHTML = '';
      responsableSelect.innerHTML = '';
      teamContainer.innerHTML = '';
      const date = new Date(dateInput.value);
      if(!equipeData){
        loadStatus.textContent = 'Sélectionnez un métier';
        chantierSelect.disabled = true;
        responsableSelect.disabled = true;
        return;
      }
      chantierSelect.disabled = false;
      responsableSelect.disabled = true;
      const col = findColumnIndex(equipeData,date);
      if(col===-1){
        return; // Message already handled in findColumnIndex
      }
      const chantiers = new Set();
      for(let r=7;r<equipeData.length;r++){
        const val = (equipeData[r][col]||'').trim();
        if(!val) continue;
        const norm = normalize(val).toLowerCase();
        if(norm==='conge' || norm==='malade') continue;
        chantiers.add(val);
      }
      const sorted = Array.from(chantiers).sort((a,b)=>a.localeCompare(b,'fr'));
      sorted.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch;
        opt.textContent = ch;
        chantierSelect.appendChild(opt);
      });
      if(sorted.length){
        chantierSelect.value = sorted[0];
        populateResponsableAndTeam();
      }
    }

    function populateResponsableAndTeam(){
      responsableSelect.innerHTML = '';
      teamContainer.innerHTML = '';
      const chantier = chantierSelect.value;
      if(!chantier || !equipeData) return;
      const date = new Date(dateInput.value);
      const col = findColumnIndex(equipeData,date);
      if(col===-1) return;
      const resps = [];
      const members = [];
      for(let r=7;r<equipeData.length;r++){
        const role = (equipeData[r][0]||'').trim().toUpperCase();
        const name = (equipeData[r][1]||'').trim();
        const affect = (equipeData[r][col]||'').trim();
        if(affect !== chantier) continue;
        if(role==='CE') resps.push(name); else members.push(name);
      }
      if(resps.length){
        resps.forEach(n=>{
          const opt=document.createElement('option');
          opt.value=n; opt.textContent=n;
          responsableSelect.appendChild(opt);
        });
        responsableSelect.disabled=false;
        responsableHelper.textContent='';
      }else{
        responsableSelect.disabled=true;
        responsableHelper.textContent='Aucun CE trouvé';
      }
      members.sort((a,b)=>a.localeCompare(b,'fr'));
      members.forEach(n=>{
        const lbl=document.createElement('label');
        lbl.className='inline-flex items-center gap-2';
        const cb=document.createElement('input');
        cb.type='checkbox'; cb.value=n; cb.className='rounded';
        lbl.appendChild(cb); lbl.append(n);
        teamContainer.appendChild(lbl);
      });
    }

    function populateVideo(){
      thumbContainer.innerHTML='Vidéo non disponible';
      qrcodeEl.innerHTML='';
      playBtn.disabled=true;
      copyLinkBtn.disabled=true;
      lastVideoUrl='';
      if(!tbmData) return;
      const monthName = new Date(dateInput.value).toLocaleString('fr-FR',{month:'long'}).toLowerCase();
      for(const row of tbmData){
        if((row[0]||'').toString().toLowerCase() === monthName){
          const url = row[1];
          if(url){
            lastVideoUrl = url;
            renderVideo(url);
          }
          break;
        }
      }
    }

    function renderVideo(url){
      const id = extractYoutubeId(url);
      const img = new Image();
      img.alt='Miniature';
      img.className='w-64 h-36 object-cover rounded';
      img.src=`https://img.youtube.com/vi/${id}/maxresdefault.jpg`;
      img.onerror=()=>{img.src=`https://img.youtube.com/vi/${id}/hqdefault.jpg`;};
      thumbContainer.innerHTML='';
      thumbContainer.appendChild(img);
      playBtn.disabled=false;
      copyLinkBtn.disabled=false;
      qrcodeEl.innerHTML='';
      new QRCode(qrcodeEl,{text:url,width:128,height:128});
    }

    function extractYoutubeId(url){
      const m = url.match(/(?:v=|\.be\/)([\w-]{11})/);
      return m?m[1]:'';
    }

    retryBtn.addEventListener('click', loadSheets);
    toggleAllBtn.addEventListener('click',()=>{
      const boxes = teamContainer.querySelectorAll('input[type="checkbox"]');
      const allChecked = Array.from(boxes).every(b=>b.checked);
      boxes.forEach(b=>b.checked=!allChecked);
    });

    metierInput.addEventListener('change',async()=>{
      const metier = metierInput.value;
      const gid = METIER_TO_GID[metier];
      if(!equipeSheets[metier] && gid){
        try{
          const data = await parseCsv(csvUrl(SHEET_BASE_URL, gid));
          equipeSheets[metier] = data;
        }catch(e){
          console.error(e);
          loadStatus.textContent = "Impossible de charger les données pour ce métier";
        }
      }
      equipeData = equipeSheets[metier] || null;
      updateAll();
    });

    chantierSelect.addEventListener('change', populateResponsableAndTeam);
    dateInput.addEventListener('change', updateAll);

    manualInput.addEventListener('keydown',e=>{
      if(e.key==='Enter'){e.preventDefault();addManual();}
    });
    manualInput.addEventListener('blur',addManual);

    function addManual(){
      const names = manualInput.value.split(',').map(n=>n.trim()).filter(n=>n);
      names.forEach(n=>{
        manualMembers.push(n);
        const chip=document.createElement('span');
        chip.className='bg-blue-100 px-2 py-1 rounded-full flex items-center gap-1';
        chip.textContent=n;
        const x=document.createElement('button');
        x.textContent='×';
        x.className='text-red-600';
        x.addEventListener('click',()=>{
          manualMembers=manualMembers.filter(m=>m!==n);
          chip.remove();
        });
        chip.appendChild(x);
        manualChips.appendChild(chip);
      });
      manualInput.value='';
    }

    playBtn.addEventListener('click',()=>{
      if(!lastVideoUrl) return;
      videoFrame.src = `${lastVideoUrl}?autoplay=1`;
      videoDialog.showModal();
    });
    videoDialog.addEventListener('click',e=>{if(e.target===videoDialog){videoDialog.close();videoFrame.src='';}});

    copyLinkBtn.addEventListener('click',async()=>{
      if(!lastVideoUrl) return;
      try{await navigator.clipboard.writeText(lastVideoUrl);}catch(e){}
    });

    sendBtn.addEventListener('click',()=>{
      const dateVal=dateInput.value;
      const metier=metierInput.value.trim();
      const chantier=chantierSelect.value;
      const responsable=responsableSelect.disabled?'':responsableSelect.value;
      const members=[...teamContainer.querySelectorAll('input[type="checkbox"]:checked')].map(b=>b.value).concat(manualMembers);
      if(!dateVal||!metier||!chantier||!responsable||!members.length||!lastVideoUrl){
        sendStatus.textContent='Veuillez remplir tous les champs.';
        return;
      }
      const entries=JSON.parse(localStorage.getItem('tbmEntries')||'[]');
      entries.push({
        savedAt:new Date().toISOString(),
        dateHeure:dateVal,
        metier,chantier,responsable,equipe:members,youtubeUrl:lastVideoUrl
      });
      localStorage.setItem('tbmEntries',JSON.stringify(entries));
      sendStatus.textContent='Enregistré';
      teamContainer.querySelectorAll('input[type="checkbox"]').forEach(b=>b.checked=false);
      manualMembers=[];manualChips.innerHTML='';
      loadHistory();
    });

    function loadHistory(){
      const entries=JSON.parse(localStorage.getItem('tbmEntries')||'[]');
      historyTable.innerHTML='';
      entries.forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class='border px-1'>${e.dateHeure}</td><td class='border px-1'>${e.metier}</td><td class='border px-1'>${e.chantier}</td><td class='border px-1'>${e.responsable}</td><td class='border px-1'>${e.equipe.join(', ')}</td>`;
        historyTable.appendChild(tr);
      });
    }

    exportBtn.addEventListener('click',()=>{
      const entries=JSON.parse(localStorage.getItem('tbmEntries')||'[]');
      if(!entries.length) return;
      const header=['savedAt','dateHeure','metier','chantier','responsable','equipe','youtubeUrl'];
      const rows=entries.map(e=>header.map(h=>Array.isArray(e[h])?e[h].join('|'):e[h]));
      let csv=header.join(',')+'\n';
      rows.forEach(r=>{csv+=r.join(',')+'\n';});
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='tbm.csv';
      a.click();
    });

    clearBtn.addEventListener('click',()=>{
      localStorage.removeItem('tbmEntries');
      loadHistory();
    });

    function init(){
      const now=new Date();
      now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
      dateInput.value=now.toISOString().slice(0,16);
      loadHistory();
      loadSheets();
    }
    init();
  </script>
</body>
</html>
